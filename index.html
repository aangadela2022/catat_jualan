<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sales Pro V9 - Ultra Fast</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; background: #f3f4f6; margin: 0; padding: 0; }
        
        /* Skeleton Loading Animation */
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        .active-tab { color: #4f46e5; border-top: 3px solid #4f46e5; }
        .tab-btn { transition: all 0.2s ease; }
        
        /* Progress Bar di bagian atas */
        #sync-indicator { position: fixed; top: 0; left: 0; height: 2px; background: #4f46e5; width: 0%; transition: width 0.3s; z-index: 100; }
    </style>
</head>
<body class="pb-20">

    <div id="sync-indicator"></div>

    <!-- Header -->
    <header class="bg-white p-4 flex justify-between items-center shadow-sm sticky top-0 z-40">
        <h1 class="font-black text-indigo-600 italic tracking-tighter">V9 ULTRA</h1>
        <div id="status-badge" class="text-[10px] font-bold px-2 py-1 rounded bg-yellow-100 text-yellow-700">OFFLINE MODE</div>
    </header>

    <main id="app" class="p-4 max-w-md mx-auto">
        <!-- Konten akan dimuat di sini secara instan -->
        <div class="space-y-4">
            <div class="h-32 rounded-3xl skeleton"></div>
            <div class="grid grid-cols-2 gap-4">
                <div class="h-20 rounded-2xl skeleton"></div>
                <div class="h-20 rounded-2xl skeleton"></div>
            </div>
        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 inset-x-0 bg-white border-t border-gray-100 h-16 flex items-center justify-around z-50">
        <button onclick="router('home')" id="nav-home" class="tab-btn flex-1 flex flex-col items-center py-2 text-gray-400">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
            <span class="text-[9px] font-bold uppercase mt-1">Home</span>
        </button>
        <button onclick="router('kasir')" id="nav-kasir" class="tab-btn flex-1 flex flex-col items-center py-2 text-gray-400">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span class="text-[9px] font-bold uppercase mt-1">Kasir</span>
        </button>
        <button onclick="router('data')" id="nav-data" class="tab-btn flex-1 flex flex-col items-center py-2 text-gray-400">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M4 7v10c0 2 1 3 3 3h10c2 0 3-1 3-3V7c0-2-1-3-3-3H7c-2 0-3 1-3 3zm0 4h16m-16 4h16"></path></svg>
            <span class="text-[9px] font-bold uppercase mt-1">Data</span>
        </button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // APP CONFIG & STATE
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ultra-fast-v9';

        let state = {
            currentView: 'home',
            products: JSON.parse(localStorage.getItem('v9_products') || '[]'),
            sales: JSON.parse(localStorage.getItem('v9_sales') || '[]'),
            stores: JSON.parse(localStorage.getItem('v9_stores') || '[]')
        };

        // ROUTER - Instant View Switch
        window.router = (view) => {
            state.currentView = view;
            render();
            // Update UI Nav
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active-tab'));
            document.getElementById(`nav-${view}`).classList.add('active-tab');
        };

        // RENDER FUNCTIONS
        function render() {
            const root = document.getElementById('app');
            if (state.currentView === 'home') {
                const total = state.sales.reduce((acc, curr) => acc + (curr.total || 0), 0);
                root.innerHTML = `
                    <div class="bg-indigo-600 rounded-3xl p-6 text-white shadow-lg shadow-indigo-200">
                        <p class="text-[10px] font-bold opacity-70 uppercase tracking-widest">Total Penjualan</p>
                        <h2 class="text-3xl font-black mt-1">Rp ${total.toLocaleString()}</h2>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-4">
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-50">
                            <p class="text-[9px] font-bold text-gray-400 uppercase">Produk</p>
                            <p class="text-xl font-black text-gray-800">${state.products.length}</p>
                        </div>
                        <div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-50">
                            <p class="text-[9px] font-bold text-gray-400 uppercase">Toko</p>
                            <p class="text-xl font-black text-gray-800">${state.stores.length}</p>
                        </div>
                    </div>
                `;
            } else if (state.currentView === 'kasir') {
                root.innerHTML = `
                    <div class="bg-white p-6 rounded-3xl shadow-sm space-y-4">
                        <h3 class="font-black text-gray-800 uppercase text-xs">Input Penjualan</h3>
                        <select id="sale-toko" class="w-full bg-gray-50 p-4 rounded-xl text-xs outline-none">
                            <option value="">Pilih Toko</option>
                            ${state.stores.map(s => `<option value="${s.nama}">${s.nama}</option>`).join('')}
                        </select>
                        <select id="sale-prod" class="w-full bg-gray-50 p-4 rounded-xl text-xs outline-none">
                            <option value="">Pilih Produk</option>
                            ${state.products.map(p => `<option value="${p.id}">${p.nama} (Rp ${p.harga?.toLocaleString()})</option>`).join('')}
                        </select>
                        <input type="number" id="sale-qty" placeholder="Jumlah Qty" class="w-full bg-gray-50 p-4 rounded-xl text-xs outline-none">
                        <button onclick="handleSale()" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg active:scale-95 transition-transform">SIMPAN</button>
                    </div>
                `;
            } else if (state.currentView === 'data') {
                root.innerHTML = `
                    <div class="bg-white p-5 rounded-3xl shadow-sm mb-4">
                        <h3 class="font-black text-xs uppercase mb-3">Tambah Produk</h3>
                        <input type="text" id="p-nama" placeholder="Nama Produk" class="w-full bg-gray-50 p-3 rounded-lg text-xs mb-2 outline-none">
                        <input type="number" id="p-harga" placeholder="Harga Jual" class="w-full bg-gray-50 p-3 rounded-lg text-xs mb-3 outline-none">
                        <button onclick="handleAddProduct()" class="w-full bg-gray-800 text-white text-[10px] font-bold py-3 rounded-lg uppercase">Tambah</button>
                    </div>
                    <div class="bg-white rounded-3xl shadow-sm overflow-hidden">
                        <table class="w-full text-left text-[10px]">
                            <thead class="bg-gray-50 font-bold text-gray-400 uppercase">
                                <tr><th class="p-3">Produk</th><th class="p-3">Harga</th></tr>
                            </thead>
                            <tbody>
                                ${state.products.map(p => `<tr><td class="p-3 border-t">${p.nama}</td><td class="p-3 border-t">Rp ${p.harga?.toLocaleString()}</td></tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }
        }

        // DATABASE SYNC - Runs in Background
        async function syncData() {
            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    await signInAnonymously(auth);
                    return;
                }
                
                document.getElementById('status-badge').innerText = "SYNCING...";
                document.getElementById('status-badge').className = "text-[10px] font-bold px-2 py-1 rounded bg-blue-100 text-blue-700";
                document.getElementById('sync-indicator').style.width = "40%";

                const uid = user.uid;
                const path = (col) => collection(db, 'artifacts', appId, 'users', uid, col);

                // Listeners (Updates local cache & UI)
                onSnapshot(path('products'), (snap) => {
                    state.products = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    localStorage.setItem('v9_products', JSON.stringify(state.products));
                    if(state.currentView === 'data') render();
                    checkSyncProgress();
                });

                onSnapshot(path('sales'), (snap) => {
                    state.sales = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    localStorage.setItem('v9_sales', JSON.stringify(state.sales));
                    if(state.currentView === 'home') render();
                    checkSyncProgress();
                });

                onSnapshot(path('stores'), (snap) => {
                    state.stores = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    localStorage.setItem('v9_stores', JSON.stringify(state.stores));
                    checkSyncProgress();
                });
            });
        }

        function checkSyncProgress() {
            document.getElementById('sync-indicator').style.width = "100%";
            document.getElementById('status-badge').innerText = "ONLINE";
            document.getElementById('status-badge').className = "text-[10px] font-bold px-2 py-1 rounded bg-green-100 text-green-700";
            setTimeout(() => { document.getElementById('sync-indicator').style.width = "0%"; }, 1000);
        }

        // HANDLERS
        window.handleAddProduct = async () => {
            const nama = document.getElementById('p-nama').value;
            const harga = Number(document.getElementById('p-harga').value);
            if(!nama || !harga) return;
            await addDoc(collection(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'products'), {
                nama, harga, createdAt: Timestamp.now()
            });
            document.getElementById('p-nama').value = '';
            document.getElementById('p-harga').value = '';
        };

        window.handleSale = async () => {
            const toko = document.getElementById('sale-toko').value;
            const pid = document.getElementById('sale-prod').value;
            const qty = Number(document.getElementById('sale-qty').value);
            if(!toko || !pid || !qty) return;

            const prod = state.products.find(p => p.id === pid);
            await addDoc(collection(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'sales'), {
                toko, prodId: pid, prodNama: prod.nama, qty, total: qty * prod.harga, createdAt: Timestamp.now()
            });
            alert("Berhasil!");
            router('home');
        };

        // INITIALIZE
        render(); // Langsung render dari cache
        syncData(); // Sinkronisasi di background
        router('home');
    </script>
</body>
</html>
