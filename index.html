<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Catat Jualan - Pedagang Keliling</title>
    <!-- CSS & Frameworks -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.0/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .nav-active { color: #2563eb; border-top: 3px solid #2563eb; background: #f8fafc; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .nav-btn { min-height: 64px; transition: all 0.2s; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        th { font-size: 10px; text-transform: uppercase; color: #94a3b8; letter-spacing: 0.05em; padding: 12px 16px; }
        td { padding: 12px 16px; border-bottom: 1px solid #f1f5f9; }
    </style>
</head>
<body class="bg-gray-50 pb-28">

    <!-- Header -->
    <header class="bg-blue-600 text-white p-4 sticky top-0 z-50 shadow-md flex justify-between items-center">
        <div class="flex items-center gap-2">
            <i data-lucide="line-chart"></i>
            <h1 class="text-xl font-bold">Catat Jualan</h1>
        </div>
        <div id="user-id-display" class="text-[10px] bg-blue-700 px-2 py-1 rounded opacity-80 uppercase tracking-widest font-mono">Connecting...</div>
    </header>

    <div class="max-w-4xl mx-auto p-4">
        
        <!-- Tab 1: Dashboard -->
        <section id="tab-dashboard" class="tab-content active">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-gray-700">
                <i data-lucide="layout-dashboard" size="20"></i> Ringkasan Hari Ini
            </h2>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-white p-4 rounded-2xl shadow-sm border-b-4 border-blue-500 text-center">
                    <p class="text-[10px] text-gray-400 uppercase font-black">Omzet Hari Ini</p>
                    <p id="stat-omzet" class="text-xl font-black text-gray-800">Rp 0</p>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border-b-4 border-green-500 text-center">
                    <p class="text-[10px] text-gray-400 uppercase font-black">Toko Dikunjungi</p>
                    <p id="stat-toko" class="text-xl font-black text-gray-800">0</p>
                </div>
            </div>
            
            <div class="flex justify-between items-center mb-3">
                <h3 class="text-xs font-black text-gray-400 uppercase tracking-widest">Transaksi Terakhir</h3>
                <button onclick="switchTab('laporan')" class="text-blue-600 text-[10px] font-bold uppercase">Lihat Semua</button>
            </div>
            <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
                <div class="table-container">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th>Waktu</th>
                                <th>Toko</th>
                                <th class="text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody id="table-sales-short" class="divide-y divide-gray-100">
                            <tr><td colspan="3" class="p-8 text-center text-gray-400 italic text-xs">Memuat data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Tab 2: Jual (Input) -->
        <section id="tab-input" class="tab-content">
             <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-gray-700">
                <i data-lucide="plus-square" size="20"></i> Catat Penjualan
             </h2>
             <div class="bg-white p-5 rounded-2xl shadow-sm border mb-6">
                <form id="form-transaksi" class="space-y-4">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Pilih Toko</label>
                        <select id="select-toko" class="w-full p-4 border-2 rounded-xl bg-gray-50 mt-1 focus:border-blue-500 outline-none transition-all" required></select>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-xl space-y-4 border border-blue-100">
                        <div>
                            <label class="text-[10px] font-bold text-blue-400 uppercase">Pilih Barang</label>
                            <select id="select-produk" class="w-full p-3 border rounded-xl bg-white mt-1"></select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Laku (Qty)</label>
                                <input type="number" id="input-qty" class="w-full p-3 border rounded-xl mt-1" placeholder="0">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-red-400 uppercase">Retur</label>
                                <input type="number" id="input-retur" class="w-full p-3 border rounded-xl bg-red-50 mt-1" placeholder="0">
                            </div>
                        </div>

                        <div id="live-calc" class="bg-white p-3 rounded-xl border border-blue-300 flex justify-between items-center shadow-sm hidden">
                            <div class="flex flex-col">
                                <span class="text-[9px] uppercase font-black text-blue-500 tracking-tighter">Harga Bayar:</span>
                                <span id="live-formula" class="text-[10px] text-gray-500 italic font-mono">-</span>
                            </div>
                            <span id="live-total" class="text-lg font-black text-blue-700">Rp 0</span>
                        </div>

                        <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-blue-700 active:scale-95 transition-all">
                            <i data-lucide="plus" size="18"></i> Tambah Item
                        </button>
                    </div>
                </form>

                <div id="transaction-preview" class="mt-8 border-t-2 border-dashed pt-6 hidden">
                    <div class="flex justify-between items-end mb-4 px-1">
                        <div>
                            <h3 class="font-black text-xs uppercase text-gray-400 tracking-widest">Detail Keranjang</h3>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] text-gray-400 uppercase font-black">Total Nota</p>
                            <span id="preview-total" class="text-xl font-black text-blue-600 leading-none">Rp 0</span>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl border shadow-sm overflow-hidden mb-6">
                        <div class="table-container">
                            <table class="w-full text-sm text-left">
                                <thead class="bg-gray-50 border-b">
                                    <tr>
                                        <th class="w-1/3 text-[9px]">Produk</th>
                                        <th class="text-right text-[9px]">L-R</th>
                                        <th class="text-right text-[9px]">Subtotal</th>
                                        <th class="w-8"></th>
                                    </tr>
                                </thead>
                                <tbody id="preview-body" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <button id="btn-submit-sale" class="w-full bg-green-600 text-white py-4 rounded-2xl font-black shadow-lg shadow-green-200 uppercase tracking-widest flex items-center justify-center gap-2 hover:bg-green-700 active:scale-[0.98] transition-all">
                        <i data-lucide="save" size="20"></i> Simpan Penjualan
                    </button>
                </div>
             </div>
        </section>

        <!-- Tab 3: Laporan Penjualan (Dengan Filter Tanggal) -->
        <section id="tab-laporan" class="tab-content">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-gray-700">
                <i data-lucide="file-text" size="20"></i> Laporan Riwayat
            </h2>
            
            <!-- Filter Tanggal -->
            <div class="bg-white p-4 rounded-2xl shadow-sm border mb-4">
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div>
                        <label class="text-[9px] font-bold text-gray-400 uppercase">Mulai Dari</label>
                        <input type="date" id="filter-date-start" class="w-full p-2 border rounded-lg text-xs mt-1 outline-none focus:border-blue-500">
                    </div>
                    <div>
                        <label class="text-[9px] font-bold text-gray-400 uppercase">Sampai Dengan</label>
                        <input type="date" id="filter-date-end" class="w-full p-2 border rounded-lg text-xs mt-1 outline-none focus:border-blue-500">
                    </div>
                </div>
                <button onclick="renderSales()" class="w-full bg-blue-100 text-blue-700 py-2 rounded-lg font-bold text-xs flex items-center justify-center gap-2">
                    <i data-lucide="filter" size="14"></i> Terapkan Filter
                </button>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
                <div class="table-container">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="whitespace-nowrap">Tgl / Jam</th>
                                <th>Toko</th>
                                <th class="text-right">Omzet</th>
                                <th class="w-8"></th>
                            </tr>
                        </thead>
                        <tbody id="table-sales-full" class="divide-y divide-gray-100">
                            <tr><td colspan="4" class="p-10 text-center text-gray-400 text-xs">Menunggu data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Tab 4: Stok -->
        <section id="tab-pembelian" class="tab-content">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-gray-700">
                <i data-lucide="truck" size="20"></i> Belanja Stok
            </h2>
            <div class="bg-white p-5 rounded-2xl shadow-sm border mb-6 text-sm">
                <form id="form-pembelian" class="space-y-4">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Pilih Produk</label>
                        <select id="buy-product" class="w-full p-3 border rounded-xl bg-gray-50 mt-1" required></select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Jumlah (Qty)</label>
                        <input type="number" id="buy-qty" placeholder="Masukkan jumlah stok baru" class="w-full p-3 border rounded-xl mt-1" required>
                    </div>
                    
                    <!-- Kalkulasi Otomatis -->
                    <div id="buy-live-calc" class="bg-indigo-50 p-4 rounded-xl border border-indigo-200 flex justify-between items-center shadow-sm hidden">
                        <div class="flex flex-col">
                            <span class="text-[9px] uppercase font-black text-indigo-500 tracking-tighter">Estimasi Total Bayar:</span>
                            <span id="buy-live-formula" class="text-[10px] text-gray-500 italic font-mono">-</span>
                        </div>
                        <span id="buy-live-total" class="text-lg font-black text-indigo-700">Rp 0</span>
                    </div>

                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-indigo-100 active:scale-95 transition-all">
                        <i data-lucide="package-plus" size="18"></i> Update Stok
                    </button>
                </form>
            </div>
            
            <h3 class="text-xs font-black text-gray-400 uppercase tracking-widest mb-3 ml-1">Riwayat Pembelian</h3>
            <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
                <div class="table-container">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th>Produk</th>
                                <th class="text-right">Qty</th>
                                <th class="text-right">Total Belanja</th>
                            </tr>
                        </thead>
                        <tbody id="table-pembelian-body" class="divide-y divide-gray-50">
                            <tr><td colspan="3" class="p-8 text-center text-gray-400 italic text-xs">Belum ada riwayat belanja</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Tab 5: Grafik & Laba -->
        <section id="tab-profit" class="tab-content">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-gray-700">
                <i data-lucide="bar-chart-3" size="20"></i> Grafik & Laba Rugi
            </h2>
            <div class="bg-white p-4 rounded-2xl shadow-sm border mb-6">
                <canvas id="salesChart" height="200"></canvas>
            </div>
            <div id="profit-summary" class="grid grid-cols-3 gap-2 mb-6 text-center"></div>
            <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
                <div class="table-container">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-400 border-b">
                            <tr>
                                <th>Produk</th>
                                <th class="text-right">Omzet</th>
                                <th class="text-right">Laba</th>
                            </tr>
                        </thead>
                        <tbody id="table-profit-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Tab 6: Master Data -->
        <section id="tab-master" class="tab-content">
            <div class="flex gap-4 mb-6">
                <button onclick="setMasterSubTab('produk')" id="btn-sub-produk" class="flex-1 py-2 font-bold border-b-2 border-blue-600 text-blue-600">Produk</button>
                <button onclick="setMasterSubTab('toko')" id="btn-sub-toko" class="flex-1 py-2 font-bold border-b-2 border-transparent text-gray-400">Toko</button>
            </div>

            <div id="sub-tab-produk">
                <div class="bg-white p-5 rounded-2xl shadow-sm border mb-4">
                    <form id="form-produk" class="space-y-3">
                        <input id="prod-nama" placeholder="Nama Produk" class="w-full p-3 border rounded-xl" required>
                        <div class="grid grid-cols-2 gap-3">
                            <input id="prod-harga-beli" type="number" placeholder="Modal" class="w-full p-3 border rounded-xl" required>
                            <input id="prod-harga" type="number" placeholder="Jual" class="w-full p-3 border rounded-xl" required>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold uppercase text-xs">Simpan Produk</button>
                    </form>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
                    <div class="table-container">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50 border-b">
                                <tr>
                                    <th>Nama</th>
                                    <th class="text-right">Jual</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="table-produk-body" class="divide-y"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="sub-tab-toko" class="hidden">
                <div class="bg-white p-5 rounded-2xl shadow-sm border mb-4">
                    <form id="form-toko" class="space-y-3">
                        <input id="toko-nama" placeholder="Nama Toko" class="w-full p-3 border rounded-xl" required>
                        <input id="toko-alamat" placeholder="Alamat Toko" class="w-full p-3 border rounded-xl" required>
                        <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold uppercase text-xs">Simpan Toko</button>
                    </form>
                </div>
                <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
                    <div class="table-container">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50 border-b">
                                <tr>
                                    <th>Toko</th>
                                    <th>Alamat</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="table-toko-body" class="divide-y"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

    </div>

    <!-- Navigasi Bawah -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex h-20 shadow-[0_-10px_30px_rgba(0,0,0,0.05)] z-50 overflow-x-auto no-scrollbar">
        <button onclick="switchTab('dashboard')" class="nav-btn flex-1 min-w-[65px] flex flex-col items-center justify-center gap-1 text-gray-400 nav-active" data-tab="dashboard">
            <i data-lucide="home" size="18"></i><span class="text-[9px] font-bold">Home</span>
        </button>
        <button onclick="switchTab('input')" class="nav-btn flex-1 min-w-[65px] flex flex-col items-center justify-center gap-1 text-gray-400" data-tab="input">
            <i data-lucide="plus-circle" size="18"></i><span class="text-[9px] font-bold">Jual</span>
        </button>
        <button onclick="switchTab('laporan')" class="nav-btn flex-1 min-w-[65px] flex flex-col items-center justify-center gap-1 text-gray-400" data-tab="laporan">
            <i data-lucide="file-text" size="18"></i><span class="text-[9px] font-bold">Laporan</span>
        </button>
        <button onclick="switchTab('pembelian')" class="nav-btn flex-1 min-w-[65px] flex flex-col items-center justify-center gap-1 text-gray-400" data-tab="pembelian">
            <i data-lucide="package" size="18"></i><span class="text-[9px] font-bold">Stok</span>
        </button>
        <button onclick="switchTab('profit')" class="nav-btn flex-1 min-w-[65px] flex flex-col items-center justify-center gap-1 text-gray-400" data-tab="profit">
            <i data-lucide="trending-up" size="18"></i><span class="text-[9px] font-bold">Grafik</span>
        </button>
        <button onclick="switchTab('master')" class="nav-btn flex-1 min-w-[65px] flex flex-col items-center justify-center gap-1 text-gray-400" data-tab="master">
            <i data-lucide="settings" size="18"></i><span class="text-[9px] font-bold">Master</span>
        </button>
    </nav>

    <div id="notification" class="fixed top-5 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-2xl text-[10px] font-bold hidden z-[100] shadow-xl uppercase tracking-widest"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let user = null;
        let products = [];
        let stores = [];
        let sales = [];
        let purchases = [];
        let currentTransactionItems = [];
        let salesChart = null;

        // Set default filter date (hari ini)
        const todayStr = new Date().toISOString().split('T')[0];
        document.getElementById('filter-date-start').value = todayStr;
        document.getElementById('filter-date-end').value = todayStr;

        window.switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => {
                if(b.dataset.tab === tabId) b.classList.add('nav-active');
                else b.classList.remove('nav-active');
            });
            if (window.lucide) window.lucide.createIcons();
            if (tabId === 'profit') setTimeout(initChart, 100);
            window.scrollTo(0, 0);
        };

        window.setMasterSubTab = (sub) => {
            if(sub === 'produk') {
                document.getElementById('sub-tab-produk').classList.remove('hidden');
                document.getElementById('sub-tab-toko').classList.add('hidden');
                document.getElementById('btn-sub-produk').classList.add('border-blue-600', 'text-blue-600');
                document.getElementById('btn-sub-toko').classList.remove('border-blue-600', 'text-blue-600');
            } else {
                document.getElementById('sub-tab-toko').classList.remove('hidden');
                document.getElementById('sub-tab-produk').classList.add('hidden');
                document.getElementById('btn-sub-toko').classList.add('border-blue-600', 'text-blue-600');
                document.getElementById('btn-sub-produk').classList.remove('border-blue-600', 'text-blue-600');
            }
        }

        const showToast = (msg) => {
            const t = document.getElementById('notification');
            t.innerText = msg;
            t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 2500);
        };

        onAuthStateChanged(auth, (u) => {
            user = u;
            if (u) {
                document.getElementById('user-id-display').innerText = `UID: ${u.uid.substring(0,8)}`;
                setupListeners(u.uid);
            } else {
                signInAnonymously(auth);
            }
        });

        function setupListeners(uid) {
            onSnapshot(collection(db, 'artifacts', appId, 'users', uid, 'products'), (s) => {
                products = s.docs.map(d => ({id: d.id, ...d.data()}));
                renderProducts();
                updateDropdowns();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'users', uid, 'stores'), (s) => {
                stores = s.docs.map(d => ({id: d.id, ...d.data()}));
                renderStores();
                updateDropdowns();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'users', uid, 'sales'), (s) => {
                sales = s.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                renderSales();
                renderProfitReport();
                updateStats();
                if(salesChart) initChart();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'users', uid, 'purchases'), (s) => {
                purchases = s.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                renderPurchases();
            });
        }

        const initChart = () => {
            const ctx = document.getElementById('salesChart')?.getContext('2d');
            if(!ctx) return;
            const dailyData = {};
            const last7Days = [];
            for(let i=6; i>=0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateStr = d.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
                last7Days.push(dateStr);
                dailyData[dateStr] = 0;
            }
            sales.forEach(s => {
                const dateStr = s.timestamp?.toDate().toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
                if(dailyData[dateStr] !== undefined) dailyData[dateStr] += s.totalOmzet;
            });
            if(salesChart) salesChart.destroy();
            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days,
                    datasets: [{
                        label: 'Omzet',
                        data: last7Days.map(day => dailyData[day]),
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
        };

        const renderProducts = () => {
            document.getElementById('table-produk-body').innerHTML = products.map(p => `
                <tr>
                    <td class="font-bold text-gray-700">${p.nama}</td>
                    <td class="text-right text-xs font-bold text-blue-600">Rp ${p.harga.toLocaleString()}</td>
                    <td class="text-right"><button onclick="window.delProd('${p.id}')" class="text-red-300">×</button></td>
                </tr>
            `).join('');
        };

        const renderStores = () => {
            document.getElementById('table-toko-body').innerHTML = stores.map(s => `
                <tr>
                    <td class="font-bold text-gray-700">${s.nama}</td>
                    <td class="text-xs text-gray-500">${s.alamat || '-'}</td>
                    <td class="text-right"><button onclick="window.delStore('${s.id}')" class="text-red-300">×</button></td>
                </tr>
            `).join('');
        };

        window.renderSales = () => {
            const start = document.getElementById('filter-date-start').value;
            const end = document.getElementById('filter-date-end').value;
            
            // Filter logic
            const filtered = sales.filter(s => {
                if(!s.timestamp) return false;
                const d = s.timestamp.toDate().toISOString().split('T')[0];
                return d >= start && d <= end;
            });

            // 1. Render Dashboard (Short - Selalu Tampilkan 5 Terakhir Tanpa Filter)
            const dashboardTable = document.getElementById('table-sales-short');
            dashboardTable.innerHTML = sales.slice(0, 5).map(s => `
                <tr>
                    <td class="text-[10px] text-gray-400 font-bold">${s.timestamp?.toDate().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'})}</td>
                    <td class="font-black text-gray-700 uppercase text-[11px]">${s.storeName}</td>
                    <td class="text-right text-xs font-black text-blue-600">Rp ${s.totalOmzet.toLocaleString()}</td>
                </tr>
            `).join('') || '<tr><td colspan="3" class="p-4 text-center text-gray-400 italic text-xs">Kosong</td></tr>';

            // 2. Render Full Report (With Filter)
            const laporanTable = document.getElementById('table-sales-full');
            if (filtered.length === 0) {
                laporanTable.innerHTML = '<tr><td colspan="4" class="p-10 text-center text-gray-400 italic text-xs">Tidak ada data untuk rentang tanggal ini.</td></tr>';
            } else {
                laporanTable.innerHTML = filtered.map(s => `
                    <tr>
                        <td class="text-[10px] text-gray-500 whitespace-nowrap">
                            ${s.timestamp?.toDate().toLocaleDateString('id-ID', {day:'numeric', month:'short'})} <br/>
                            <span class="font-black text-gray-700">${s.timestamp?.toDate().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'})}</span>
                        </td>
                        <td class="font-bold text-gray-700 uppercase text-[10px] leading-tight">${s.storeName}</td>
                        <td class="text-right text-xs font-black text-blue-600">Rp ${s.totalOmzet.toLocaleString()}</td>
                        <td class="text-right">
                            <button onclick="window.delSale('${s.id}')" class="text-red-300 p-2">
                                <i data-lucide="trash-2" size="14"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }
            if (window.lucide) window.lucide.createIcons();
        };

        const renderPurchases = () => {
            const body = document.getElementById('table-pembelian-body');
            if (purchases.length === 0) {
                body.innerHTML = '<tr><td colspan="3" class="p-8 text-center text-gray-400 italic text-xs">Belum ada riwayat belanja</td></tr>';
                return;
            }
            body.innerHTML = purchases.map(p => `
                <tr>
                    <td>
                        <div class="flex flex-col">
                            <span class="font-bold text-gray-700">${p.productName}</span>
                            <span class="text-[9px] text-gray-400 uppercase">${p.timestamp?.toDate().toLocaleDateString('id-ID', {day:'numeric', month:'short'})}</span>
                        </div>
                    </td>
                    <td class="text-right text-xs font-mono font-bold">${p.qty}</td>
                    <td class="text-right font-black text-indigo-600">Rp ${p.total.toLocaleString()}</td>
                </tr>
            `).join('');
        };

        const renderProfitReport = () => {
            const b = document.getElementById('table-profit-body');
            const summary = document.getElementById('profit-summary');
            let tO = 0, tM = 0;
            const map = {};
            sales.forEach(s => {
                s.items.forEach(i => {
                    if(!map[i.productId]) map[i.productId] = { n: i.nama, o: 0, m: 0 };
                    map[i.productId].o += i.subtotal;
                    map[i.productId].m += (i.qty - i.retur) * (i.hargaBeli || 0);
                    tO += i.subtotal;
                    tM += (i.qty - i.retur) * (i.hargaBeli || 0);
                });
            });
            summary.innerHTML = `
                <div class="bg-blue-600 p-3 rounded-2xl text-white"><p class="text-[8px] uppercase font-black opacity-60">Omzet</p><p class="font-black text-[10px]">Rp ${tO.toLocaleString()}</p></div>
                <div class="bg-gray-800 p-3 rounded-2xl text-white"><p class="text-[8px] uppercase font-black opacity-60">Modal</p><p class="font-black text-[10px]">Rp ${tM.toLocaleString()}</p></div>
                <div class="bg-green-600 p-3 rounded-2xl text-white"><p class="text-[8px] uppercase font-black opacity-60">Laba</p><p class="font-black text-[10px]">Rp ${(tO-tM).toLocaleString()}</p></div>
            `;
            b.innerHTML = Object.values(map).map(d => `
                <tr>
                    <td class="font-bold text-gray-700 text-xs">${d.n}</td>
                    <td class="text-right text-xs">Rp ${d.o.toLocaleString()}</td>
                    <td class="text-right font-black text-green-600 text-xs">Rp ${(d.o-d.m).toLocaleString()}</td>
                </tr>
            `).join('');
        };

        const updateStats = () => {
            const todayDateStr = new Date().toLocaleDateString('id-ID');
            const todaysSales = sales.filter(s => s.timestamp?.toDate().toLocaleDateString('id-ID') === todayDateStr);
            const totalOmzet = todaysSales.reduce((acc, curr) => acc + curr.totalOmzet, 0);
            const uniqueStores = new Set(todaysSales.map(s => s.storeId)).size;
            document.getElementById('stat-omzet').innerText = `Rp ${totalOmzet.toLocaleString()}`;
            document.getElementById('stat-toko').innerText = uniqueStores;
        };

        const updateDropdowns = () => {
            const pOpts = '<option value="">-- Pilih Produk --</option>' + products.map(p => `<option value="${p.id}">${p.nama}</option>`).join('');
            document.getElementById('select-produk').innerHTML = pOpts;
            document.getElementById('buy-product').innerHTML = pOpts;
            document.getElementById('select-toko').innerHTML = '<option value="">-- Pilih Toko --</option>' + stores.map(s => `<option value="${s.id}">${s.nama}</option>`).join('');
        };

        const calculateLiveTotal = () => {
            const pid = document.getElementById('select-produk').value;
            const q = parseInt(document.getElementById('input-qty').value) || 0;
            const r = parseInt(document.getElementById('input-retur').value) || 0;
            const liveDiv = document.getElementById('live-calc');
            const liveFormula = document.getElementById('live-formula');
            const liveTotal = document.getElementById('live-total');
            if (!pid) { liveDiv.classList.add('hidden'); return; }
            const p = products.find(x => x.id === pid);
            if (p) {
                const totalItem = (q - r) * p.harga;
                liveDiv.classList.remove('hidden');
                liveFormula.innerText = `(${q} - ${r}) x Rp ${p.harga.toLocaleString()}`;
                liveTotal.innerText = `Rp ${totalItem.toLocaleString()}`;
                if (totalItem < 0) liveTotal.classList.replace('text-blue-700', 'text-red-600');
                else liveTotal.classList.replace('text-red-600', 'text-blue-700');
            } else { liveDiv.classList.add('hidden'); }
        };

        // Logika Hitung Stok Otomatis
        const calculateBuyLiveTotal = () => {
            const pid = document.getElementById('buy-product').value;
            const q = parseInt(document.getElementById('buy-qty').value) || 0;
            const liveDiv = document.getElementById('buy-live-calc');
            const liveFormula = document.getElementById('buy-live-formula');
            const liveTotal = document.getElementById('buy-live-total');
            
            if (!pid || q <= 0) { liveDiv.classList.add('hidden'); return; }
            
            const p = products.find(x => x.id === pid);
            if (p) {
                const modal = p.hargaBeli || 0;
                const total = q * modal;
                liveDiv.classList.remove('hidden');
                liveFormula.innerText = `${q} x Modal (Rp ${modal.toLocaleString()})`;
                liveTotal.innerText = `Rp ${total.toLocaleString()}`;
            } else { liveDiv.classList.add('hidden'); }
        };

        document.getElementById('select-produk').addEventListener('change', calculateLiveTotal);
        document.getElementById('input-qty').addEventListener('input', calculateLiveTotal);
        document.getElementById('input-retur').addEventListener('input', calculateLiveTotal);
        
        // Listeners untuk form beli
        document.getElementById('buy-product').addEventListener('change', calculateBuyLiveTotal);
        document.getElementById('buy-qty').addEventListener('input', calculateBuyLiveTotal);

        const renderTransactionPreview = () => {
            const previewEl = document.getElementById('transaction-preview');
            const bodyEl = document.getElementById('preview-body');
            const totalEl = document.getElementById('preview-total');
            if (currentTransactionItems.length === 0) { previewEl.classList.add('hidden'); return; }
            previewEl.classList.remove('hidden');
            bodyEl.innerHTML = currentTransactionItems.map((item, idx) => `
                <tr class="hover:bg-gray-50">
                    <td class="py-3 font-bold text-gray-700"><span class="text-xs uppercase">${item.nama}</span></td>
                    <td class="py-3 text-right"><div class="flex flex-col items-end"><span class="text-xs font-medium">${item.qty} L</span>${item.retur > 0 ? `<span class="text-[9px] text-red-500">-${item.retur} R</span>` : ''}</div></td>
                    <td class="py-3 text-right text-xs font-black text-gray-800">Rp ${item.subtotal.toLocaleString()}</td>
                    <td class="py-3 text-right"><button onclick="window.removeLocalItem(${idx})" class="p-1 text-red-300">×</button></td>
                </tr>
            `).join('');
            totalEl.innerText = "Rp " + currentTransactionItems.reduce((a,b)=>a+b.subtotal, 0).toLocaleString();
            if (window.lucide) window.lucide.createIcons();
        };

        document.getElementById('form-transaksi').onsubmit = (e) => {
            e.preventDefault();
            const pid = document.getElementById('select-produk').value;
            const q = parseInt(document.getElementById('input-qty').value) || 0;
            const r = parseInt(document.getElementById('input-retur').value) || 0;
            if(!pid || (q === 0 && r === 0)) return;
            const p = products.find(x => x.id === pid);
            currentTransactionItems.push({ productId: pid, nama: p.nama, qty: q, retur: r, harga: p.harga, hargaBeli: p.hargaBeli || 0, subtotal: (q - r) * p.harga });
            renderTransactionPreview();
            e.target.reset();
            document.getElementById('live-calc').classList.add('hidden');
            document.getElementById('select-produk').focus();
        };

        window.removeLocalItem = (idx) => {
            currentTransactionItems.splice(idx, 1);
            renderTransactionPreview();
        };

        document.getElementById('btn-submit-sale').onclick = async () => {
            const sid = document.getElementById('select-toko').value;
            if(!sid || currentTransactionItems.length === 0) { showToast("Pilih Toko!"); return; }
            const store = stores.find(x => x.id === sid);
            await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'sales'), { 
                storeId: sid, 
                storeName: store.nama, 
                items: currentTransactionItems, 
                totalOmzet: currentTransactionItems.reduce((a,b) => a + b.subtotal, 0), 
                timestamp: Timestamp.now() 
            });
            currentTransactionItems = [];
            renderTransactionPreview();
            showToast("Tersimpan!");
            switchTab('dashboard');
        };

        document.getElementById('form-pembelian').onsubmit = async (e) => {
            e.preventDefault();
            const pid = document.getElementById('buy-product').value;
            const q = parseInt(document.getElementById('buy-qty').value);
            if(!pid || q <= 0) return;
            
            const p = products.find(x => x.id === pid);
            const modal = p.hargaBeli || 0;
            const totalBelanja = q * modal;
            
            await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'purchases'), { 
                productId: pid, 
                productName: p.nama, 
                qty: q, 
                hargaBeliUnit: modal, 
                total: totalBelanja, 
                timestamp: Timestamp.now() 
            });
            
            e.target.reset();
            document.getElementById('buy-live-calc').classList.add('hidden');
            showToast("Stok Diperbarui!");
        };

        document.getElementById('form-produk').onsubmit = async (e) => {
            e.preventDefault();
            const n = document.getElementById('prod-nama').value;
            const hb = parseInt(document.getElementById('prod-harga-beli').value);
            const h = parseInt(document.getElementById('prod-harga').value);
            await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'products'), { nama: n, hargaBeli: hb, harga: h });
            e.target.reset();
            showToast("Produk Ditambah!");
        };

        document.getElementById('form-toko').onsubmit = async (e) => {
            e.preventDefault();
            const n = document.getElementById('toko-nama').value;
            const a = document.getElementById('toko-alamat').value;
            await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'stores'), { nama: n, alamat: a });
            e.target.reset();
            showToast("Toko Ditambah!");
        };

        window.delProd = (id) => user && confirm("Hapus Produk?") && deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'products', id));
        window.delStore = (id) => user && confirm("Hapus Toko?") && deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'stores', id));
        window.delSale = (id) => user && confirm("Hapus Transaksi?") && deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'sales', id));

        window.onload = () => { if (window.lucide) window.lucide.createIcons(); };
    </script>
</body>
</html>
