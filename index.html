<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sales Pro V9 - Fast Load</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; background: #f9fafb; }
        .active-tab { color: #4f46e5; }
        .indicator { height: 3px; width: 12px; background: #4f46e5; border-radius: 10px; margin-top: 4px; }
        #loading-overlay { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.3s ease-out; }
        .sub-nav-active { background: #4f46e5; color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2); }
        input, select { -webkit-appearance: none; appearance: none; }
    </style>
</head>
<body class="pb-24">

    <!-- Fast Loading Overlay -->
    <div id="loading-overlay">
        <div class="relative">
            <div class="w-12 h-12 border-4 border-indigo-100 border-t-indigo-600 rounded-full animate-spin"></div>
        </div>
        <p class="mt-4 text-[10px] font-bold uppercase tracking-[0.2em] text-indigo-600 animate-pulse">Memuat Sistem...</p>
    </div>

    <header class="bg-white/80 backdrop-blur-md border-b border-gray-100 p-4 sticky top-0 z-50 flex justify-between items-center">
        <div class="flex flex-col">
            <span class="font-black text-indigo-700 leading-none tracking-tighter text-lg italic">SALES PRO V9</span>
            <span class="text-[8px] font-bold text-gray-400 uppercase tracking-widest mt-0.5">Premium Management</span>
        </div>
        <div id="user-display" class="text-[9px] bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-lg font-bold border border-indigo-100">
            Connecting...
        </div>
    </header>

    <main id="app-container" class="max-w-2xl mx-auto p-4 space-y-4">
        <!-- Konten diisi oleh JS -->
    </main>

    <!-- Navigasi Bawah -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-lg border-t border-gray-100 flex h-20 shadow-2xl z-50 px-4 items-center">
        <button onclick="changeTab('dashboard')" class="flex-1 flex flex-col items-center gap-1 text-gray-400 transition-colors" id="tab-dashboard">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
            <span class="text-[8px] font-black uppercase tracking-widest">Beranda</span>
            <div class="indicator hidden"></div>
        </button>
        <button onclick="changeTab('kasir')" class="flex-1 flex flex-col items-center gap-1 text-gray-400 transition-colors" id="tab-kasir">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            <span class="text-[8px] font-black uppercase tracking-widest">Kasir</span>
            <div class="indicator hidden"></div>
        </button>
        <button onclick="changeTab('gudang')" class="flex-1 flex flex-col items-center gap-1 text-gray-400 transition-colors" id="tab-gudang">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
            <span class="text-[8px] font-black uppercase tracking-widest">Gudang</span>
            <div class="indicator hidden"></div>
        </button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // Global State
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'fast-v9-app';
        
        let state = {
            user: null,
            products: [],
            stores: [],
            sales: [],
            activeTab: 'dashboard',
            activeGudangSub: 'produk'
        };

        // Inisialisasi Cepat
        async function init() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    state.user = user;
                    document.getElementById('user-display').innerText = `ID: ${user.uid.slice(0,6)}`;
                    setupListeners();
                } else {
                    await signInAnonymously(auth);
                }
            });
        }

        function setupListeners() {
            const path = (name) => collection(db, 'artifacts', appId, 'users', state.user.uid, name);
            let ready = { p: false, s: false, sa: false };

            const checkReady = () => {
                if(ready.p && ready.s && ready.sa) {
                    document.getElementById('loading-overlay').style.opacity = '0';
                    setTimeout(() => document.getElementById('loading-overlay').remove(), 300);
                    render();
                }
            };

            onSnapshot(path('products'), (s) => {
                state.products = s.docs.map(d => ({id: d.id, ...d.data()}));
                ready.p = true; checkReady(); render();
            }, () => { ready.p = true; checkReady(); });

            onSnapshot(path('stores'), (s) => {
                state.stores = s.docs.map(d => ({id: d.id, ...d.data()}));
                ready.s = true; checkReady(); render();
            }, () => { ready.s = true; checkReady(); });

            onSnapshot(path('sales'), (s) => {
                state.sales = s.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => b.timestamp - a.timestamp);
                ready.sa = true; checkReady(); render();
            }, () => { ready.sa = true; checkReady(); });
        }

        // Action Handlers
        window.changeTab = (tab) => { state.activeTab = tab; render(); };
        window.changeSubGudang = (sub) => { state.activeGudangSub = sub; render(); };

        window.handleSaveSale = async () => {
            const toko = document.getElementById('sale-toko').value;
            const pid = document.getElementById('sale-pid').value;
            const qty = Number(document.getElementById('sale-qty').value);
            if(!toko || !pid || !qty) return alert("Lengkapi data!");

            const p = state.products.find(x => x.id === pid);
            await addDoc(collection(db, 'artifacts', appId, 'users', state.user.uid, 'sales'), {
                storeName: toko, prodNama: p.nama, qty, total: qty * p.hargaJual, timestamp: Timestamp.now()
            });
            document.getElementById('sale-qty').value = "";
        };

        window.handleSaveStore = async () => {
            const n = document.getElementById('st-n').value;
            const a = document.getElementById('st-a').value;
            if(!n) return alert("Nama wajib isi!");
            await addDoc(collection(db, 'artifacts', appId, 'users', state.user.uid, 'stores'), {
                nama: n, alamat: a, timestamp: Timestamp.now()
            });
            alert("Toko Tersimpan!");
        };

        window.handleSaveProd = async () => {
            const n = document.getElementById('pr-n').value;
            const j = Number(document.getElementById('pr-j').value);
            const s = Number(document.getElementById('pr-s').value);
            if(!n || !j) return alert("Isi data produk!");
            await addDoc(collection(db, 'artifacts', appId, 'users', state.user.uid, 'products'), {
                nama: n, hargaJual: j, stok: s, timestamp: Timestamp.now()
            });
            alert("Produk Tersimpan!");
        };

        window.deleteData = async (col, id) => {
            if(confirm("Hapus?")) await deleteDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, col, id));
        };

        // UI Renderer
        function render() {
            const container = document.getElementById('app-container');
            
            // Nav Updates
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active-tab'));
            document.querySelectorAll('.indicator').forEach(i => i.classList.add('hidden'));
            const activeNav = document.getElementById(`tab-${state.activeTab}`);
            activeNav.classList.add('active-tab');
            activeNav.querySelector('.indicator').classList.remove('hidden');

            if (state.activeTab === 'dashboard') {
                const total = state.sales.reduce((a,b) => a + b.total, 0);
                container.innerHTML = `
                    <div class="bg-indigo-600 p-6 rounded-[2rem] text-white shadow-xl shadow-indigo-200">
                        <p class="text-[10px] font-black uppercase tracking-[0.2em] opacity-60">Total Omset</p>
                        <h2 class="text-3xl font-black mt-1">Rp ${total.toLocaleString()}</h2>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-white p-4 rounded-3xl border border-gray-100">
                            <p class="text-[8px] font-black text-gray-400 uppercase tracking-widest">Toko</p>
                            <p class="text-xl font-bold text-gray-800">${state.stores.length}</p>
                        </div>
                        <div class="bg-white p-4 rounded-3xl border border-gray-100">
                            <p class="text-[8px] font-black text-gray-400 uppercase tracking-widest">Produk</p>
                            <p class="text-xl font-bold text-gray-800">${state.products.length}</p>
                        </div>
                    </div>
                    <div class="bg-white p-5 rounded-3xl border border-gray-100">
                        <h3 class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-4">Penjualan Terakhir</h3>
                        <div class="space-y-4">
                            ${state.sales.slice(0,5).map(s => `
                                <div class="flex justify-between items-center">
                                    <div class="flex flex-col">
                                        <span class="text-xs font-bold text-gray-800">${s.prodNama}</span>
                                        <span class="text-[9px] text-gray-400 uppercase">${s.storeName}</span>
                                    </div>
                                    <span class="text-xs font-black text-emerald-500">Rp ${s.total.toLocaleString()}</span>
                                </div>
                            `).join('') || '<p class="text-center text-[10px] text-gray-300 py-6">Belum ada transaksi</p>'}
                        </div>
                    </div>
                `;
            }

            if (state.activeTab === 'kasir') {
                container.innerHTML = `
                    <div class="bg-white p-6 rounded-[2rem] border border-gray-100 space-y-4 shadow-sm">
                        <h3 class="text-[10px] font-black text-indigo-600 uppercase tracking-[0.2em]">Form Kasir</h3>
                        <select id="sale-toko" class="w-full p-4 bg-gray-50 rounded-2xl text-xs border-0 outline-none focus:ring-2 focus:ring-indigo-100 transition-all">
                            <option value="">Pilih Toko</option>
                            ${state.stores.map(s => `<option value="${s.nama}">${s.nama}</option>`).join('')}
                        </select>
                        <select id="sale-pid" class="w-full p-4 bg-gray-50 rounded-2xl text-xs border-0 outline-none focus:ring-2 focus:ring-indigo-100 transition-all">
                            <option value="">Pilih Produk</option>
                            ${state.products.map(p => `<option value="${p.id}">${p.nama} (Rp ${p.hargaJual.toLocaleString()})</option>`).join('')}
                        </select>
                        <input type="number" id="sale-qty" placeholder="Jumlah Qty" class="w-full p-4 bg-gray-50 rounded-2xl text-xs border-0 focus:ring-2 focus:ring-indigo-100">
                        <button onclick="handleSaveSale()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black uppercase text-[10px] tracking-widest shadow-lg active:scale-95 transition-all">Simpan Transaksi</button>
                    </div>

                    <div class="bg-white rounded-3xl border border-gray-100 overflow-hidden">
                        <div class="p-4 border-b border-gray-50 flex justify-between">
                            <h4 class="text-[9px] font-black text-gray-400 uppercase tracking-widest">Riwayat</h4>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-gray-50">
                                    <tr class="text-[8px] font-black text-gray-400 uppercase">
                                        <th class="p-4">Toko</th>
                                        <th class="p-4">Item</th>
                                        <th class="p-4 text-right">Total</th>
                                        <th class="p-4 text-center"></th>
                                    </tr>
                                </thead>
                                <tbody class="text-[10px]">
                                    ${state.sales.map(s => `
                                        <tr class="border-b border-gray-50">
                                            <td class="p-4 font-bold">${s.storeName}</td>
                                            <td class="p-4">${s.prodNama} (${s.qty})</td>
                                            <td class="p-4 text-right font-black">Rp ${s.total.toLocaleString()}</td>
                                            <td class="p-4 text-center"><button onclick="deleteData('sales','${s.id}')" class="text-red-400">×</button></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            if (state.activeTab === 'gudang') {
                container.innerHTML = `
                    <div class="flex bg-gray-100 p-1.5 rounded-2xl">
                        <button onclick="changeSubGudang('produk')" class="flex-1 py-2.5 rounded-xl text-[9px] font-black uppercase tracking-widest transition-all ${state.activeGudangSub === 'produk' ? 'sub-nav-active shadow-sm' : 'text-gray-400'}">Daftar Produk</button>
                        <button onclick="changeSubGudang('toko')" class="flex-1 py-2.5 rounded-xl text-[9px] font-black uppercase tracking-widest transition-all ${state.activeGudangSub === 'toko' ? 'sub-nav-active shadow-sm' : 'text-gray-400'}">Daftar Toko</button>
                    </div>

                    ${state.activeGudangSub === 'produk' ? `
                        <div class="bg-white p-5 rounded-3xl border border-gray-100 space-y-3 shadow-sm">
                            <h4 class="text-[9px] font-black text-indigo-600 uppercase tracking-widest">Input Produk Baru</h4>
                            <input type="text" id="pr-n" placeholder="Nama Produk" class="w-full p-4 bg-gray-50 rounded-2xl text-xs border-0">
                            <div class="grid grid-cols-2 gap-3">
                                <input type="number" id="pr-j" placeholder="Harga Jual" class="p-4 bg-gray-50 rounded-2xl text-xs border-0">
                                <input type="number" id="pr-s" placeholder="Stok Awal" class="p-4 bg-gray-50 rounded-2xl text-xs border-0">
                            </div>
                            <button onclick="handleSaveProd()" class="w-full bg-gray-800 text-white py-3.5 rounded-2xl font-black uppercase text-[9px] tracking-widest">Tambah Stok</button>
                        </div>
                        <div class="bg-white rounded-3xl border border-gray-100 overflow-hidden mt-4">
                            <table class="w-full text-left text-[10px]">
                                <thead class="bg-gray-50 text-[8px] font-black text-gray-400 uppercase">
                                    <tr><th class="p-4">Nama</th><th class="p-4 text-right">Harga</th><th class="p-4 text-center">Stok</th><th class="p-4"></th></tr>
                                </thead>
                                <tbody>
                                    ${state.products.map(p => `
                                        <tr class="border-b border-gray-50"><td class="p-4 font-bold">${p.nama}</td><td class="p-4 text-right">Rp ${p.hargaJual.toLocaleString()}</td><td class="p-4 text-center">${p.stok}</td><td class="p-4"><button onclick="deleteData('products','${p.id}')">×</button></td></tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : `
                        <div class="bg-white p-5 rounded-3xl border border-gray-100 space-y-3 shadow-sm">
                            <h4 class="text-[9px] font-black text-indigo-600 uppercase tracking-widest">Input Toko/Mitra</h4>
                            <input type="text" id="st-n" placeholder="Nama Toko" class="w-full p-4 bg-gray-50 rounded-2xl text-xs border-0">
                            <input type="text" id="st-a" placeholder="Alamat/Wilayah" class="w-full p-4 bg-gray-50 rounded-2xl text-xs border-0">
                            <button onclick="handleSaveStore()" class="w-full bg-emerald-600 text-white py-3.5 rounded-2xl font-black uppercase text-[9px] tracking-widest">Simpan Data Toko</button>
                        </div>
                        <div class="bg-white rounded-3xl border border-gray-100 overflow-hidden mt-4">
                            <table class="w-full text-left text-[10px]">
                                <thead class="bg-gray-50 text-[8px] font-black text-gray-400 uppercase">
                                    <tr><th class="p-4">Nama Toko</th><th class="p-4">Alamat</th><th class="p-4"></th></tr>
                                </thead>
                                <tbody>
                                    ${state.stores.map(s => `
                                        <tr class="border-b border-gray-50"><td class="p-4 font-bold">${s.nama}</td><td class="p-4 text-gray-500">${s.alamat || '-'}</td><td class="p-4 text-center"><button onclick="deleteData('stores','${s.id}')">×</button></td></tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}
                `;
            }
        }

        init();
    </script>
</body>
</html>
