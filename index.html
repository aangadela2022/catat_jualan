import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged,
  signInWithCustomToken 
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  doc, 
  addDoc, 
  updateDoc, 
  onSnapshot, 
  deleteDoc, 
  Timestamp 
} from 'firebase/firestore';

// Konfigurasi Firebase dari Environment
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'v8-financial-system';
const apiKey = ""; // API Key disediakan oleh runtime

export default function App() {
  const [user, setUser] = useState(null);
  const [activeTab, setActiveTab] = useState('dashboard');
  const [subTabMaster, setSubTabMaster] = useState('produk');
  const [products, setProducts] = useState([]);
  const [stores, setStores] = useState([]);
  const [sales, setSales] = useState([]);
  const [loading, setLoading] = useState(true);

  // State Form Transaksi
  const [saleToko, setSaleToko] = useState('');
  const [saleProduk, setSaleProduk] = useState('');
  const [saleQty, setSaleQty] = useState('');
  const [saleRetur, setSaleRetur] = useState('');

  // State Form Master Data (Updated)
  const [newProdNama, setNewProdNama] = useState('');
  const [newProdHargaBeli, setNewProdHargaBeli] = useState('');
  const [newProdHargaJual, setNewProdHargaJual] = useState('');
  const [newProdStok, setNewProdStok] = useState('');
  const [newStoreNama, setNewStoreNama] = useState('');
  const [newStoreAlamat, setNewStoreAlamat] = useState('');

  // State AI
  const [aiAnalysis, setAiAnalysis] = useState('');
  const [isAiLoading, setIsAiLoading] = useState(false);

  // Autentikasi
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Auth Error:", err);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  // Firestore Listeners
  useEffect(() => {
    if (!user) return;
    const path = (c) => collection(db, 'artifacts', appId, 'users', user.uid, c);

    const unsubP = onSnapshot(path('products'), (s) => {
      setProducts(s.docs.map(d => ({ id: d.id, ...d.data() })));
    }, (err) => console.error(err));
    
    const unsubT = onSnapshot(path('stores'), (s) => {
      setStores(s.docs.map(d => ({ id: d.id, ...d.data() })));
    }, (err) => console.error(err));
    
    const unsubS = onSnapshot(path('sales'), (s) => {
      const data = s.docs.map(d => ({ id: d.id, ...d.data() }));
      setSales(data.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)));
      setLoading(false);
    }, (err) => console.error(err));

    return () => { unsubP(); unsubT(); unsubS(); };
  }, [user]);

  // Fungsi Panggil Gemini AI
  const callGemini = async (prompt) => {
    setIsAiLoading(true);
    const systemPrompt = "Anda adalah asisten ahli manajemen toko retail di Indonesia. Berikan analisis dalam bahasa Indonesia yang profesional dan mudah dimengerti.";
    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          systemInstruction: { parts: [{ text: systemPrompt }] }
        })
      });
      const result = await response.json();
      setIsAiLoading(false);
      return result.candidates?.[0]?.content?.parts?.[0]?.text;
    } catch (error) {
      console.error("Gemini Error:", error);
      setIsAiLoading(false);
      return "Maaf, gagal memproses analisis AI.";
    }
  };

  const handleAiAnalysis = async () => {
    const today = new Date().toLocaleDateString('id-ID');
    const todaySales = sales.filter(s => s.timestamp?.toDate().toLocaleDateString('id-ID') === today);
    if (todaySales.length === 0) return alert("Belum ada data transaksi hari ini untuk dianalisis.");
    
    const prompt = `Data penjualan hari ini: ${JSON.stringify(todaySales)}. Tolong analisis performa penjualan, margin keuntungan (jika ada data harga beli), dan berikan saran singkat untuk besok.`;
    const res = await callGemini(prompt);
    setAiAnalysis(res);
    setActiveTab('ai');
  };

  // Logika Tambah Master Data (Updated with Harga Beli & Alamat)
  const addProduct = async () => {
    if (!newProdNama || !newProdHargaJual || !newProdHargaBeli || !newProdStok) return alert("Mohon lengkapi semua data produk");
    await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'products'), {
      nama: newProdNama,
      hargaBeli: parseInt(newProdHargaBeli),
      hargaJual: parseInt(newProdHargaJual),
      stok: parseInt(newProdStok),
      timestamp: Timestamp.now()
    });
    setNewProdNama(''); setNewProdHargaBeli(''); setNewProdHargaJual(''); setNewProdStok('');
  };

  const addStore = async () => {
    if (!newStoreNama || !newStoreAlamat) return alert("Mohon isi nama dan alamat toko");
    await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'stores'), {
      nama: newStoreNama,
      alamat: newStoreAlamat,
      timestamp: Timestamp.now()
    });
    setNewStoreNama(''); setNewStoreAlamat('');
  };

  // Logika Transaksi
  const saveSale = async () => {
    if (!saleToko || !saleProduk || (!saleQty && !saleRetur)) return alert("Data transaksi tidak lengkap");
    const p = products.find(x => x.id === saleProduk);
    const s = stores.find(x => x.id === saleToko);
    const qty = parseInt(saleQty) || 0;
    const ret = parseInt(saleRetur) || 0;
    
    // Gunakan hargaJual
    const total = (qty - ret) * p.hargaJual;
    const modal = (qty - ret) * p.hargaBeli;

    await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'sales'), {
      storeId: saleToko,
      storeName: s.nama,
      items: [{ 
        productId: saleProduk, 
        nama: p.nama, 
        qty, 
        retur: ret, 
        hargaJual: p.hargaJual, 
        hargaBeli: p.hargaBeli,
        subtotal: total,
        profit: total - modal
      }],
      totalOmzet: total,
      totalProfit: total - modal,
      timestamp: Timestamp.now()
    });

    await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'products', saleProduk), {
      stok: p.stok - qty + ret
    });

    setSaleQty(''); setSaleRetur(''); setSaleProduk('');
    alert("Transaksi Berhasil Disimpan!");
  };

  if (loading) return <div className="flex h-screen items-center justify-center bg-indigo-50 text-indigo-600 font-bold tracking-widest uppercase text-xs animate-pulse">Memuat Sistem Penjualan...</div>;

  const todayStr = new Date().toLocaleDateString('id-ID');
  const todaySales = sales.filter(s => s.timestamp?.toDate().toLocaleDateString('id-ID') === todayStr);
  const totalOmzetToday = todaySales.reduce((a, c) => a + c.totalOmzet, 0);

  return (
    <div className="bg-gray-50 min-h-screen pb-32 font-sans text-gray-800">
      <header className="bg-indigo-700 text-white p-5 sticky top-0 z-50 shadow-md flex justify-between items-center">
        <div className="flex items-center gap-2">
          <span className="font-black italic text-xl tracking-tighter">SALES PRO V8</span>
        </div>
        <div className="text-[10px] bg-white/20 px-3 py-1 rounded-full font-mono font-bold uppercase backdrop-blur-sm">
          UID: {user?.uid.slice(0, 8)}
        </div>
      </header>

      <main className="max-w-4xl mx-auto p-4 space-y-4">
        {activeTab === 'dashboard' && (
          <div className="space-y-4 animate-in fade-in slide-in-from-bottom-2 duration-500">
            <div className="grid grid-cols-2 gap-4">
              <div className="bg-white p-5 rounded-3xl shadow-sm border-l-4 border-emerald-500">
                <p className="text-[10px] text-gray-400 uppercase font-black">Omzet Hari Ini</p>
                <p className="text-xl font-black text-gray-800">Rp {totalOmzetToday.toLocaleString()}</p>
              </div>
              <div onClick={handleAiAnalysis} className="bg-indigo-600 p-5 rounded-3xl shadow-lg cursor-pointer active:scale-95 transition-all hover:bg-indigo-700 flex flex-col justify-center items-center text-white">
                <p className="text-[10px] uppercase font-black opacity-80 text-center tracking-widest">Analisis Pintar</p>
                <p className="text-xs font-bold">âœ¨ Tanya Gemini AI</p>
              </div>
            </div>
            
            <div className="bg-white p-6 rounded-3xl border border-gray-100 shadow-sm">
                <h3 className="text-xs font-black text-indigo-600 uppercase mb-4 tracking-widest">Status Stok Produk</h3>
                <div className="space-y-3">
                    {products.length === 0 ? <p className="text-xs text-gray-400 italic py-4">Belum ada produk terdaftar.</p> : 
                    products.slice(0,5).map(p => (
                        <div key={p.id} className="flex justify-between items-center text-sm border-b border-gray-50 pb-3 last:border-0">
                            <div>
                                <p className="font-bold text-gray-700">{p.nama}</p>
                                <p className="text-[10px] text-gray-400">Jual: Rp {p.hargaJual?.toLocaleString()}</p>
                            </div>
                            <div className={`px-3 py-1 rounded-full text-[10px] font-black ${p.stok < 10 ? "bg-red-50 text-red-500" : "bg-emerald-50 text-emerald-600"}`}>
                                {p.stok} UNIT
                            </div>
                        </div>
                    ))}
                </div>
            </div>
          </div>
        )}

        {activeTab === 'penjualan' && (
          <div className="space-y-4 animate-in fade-in slide-in-from-bottom-2 duration-500">
            <div className="bg-white p-6 rounded-3xl border shadow-sm space-y-4">
              <h2 className="text-sm font-black text-indigo-600 uppercase tracking-widest">Input Penjualan Harian</h2>
              <div className="space-y-4">
                <div className="space-y-1">
                    <label className="text-[10px] font-bold text-gray-400 ml-2 uppercase">Pilih Lokasi Toko</label>
                    <select value={saleToko} onChange={e => setSaleToko(e.target.value)} className="w-full p-4 border-0 rounded-2xl bg-gray-50 text-sm focus:ring-2 focus:ring-indigo-500">
                    <option value="">-- Pilih Toko --</option>
                    {stores.map(s => <option key={s.id} value={s.id}>{s.nama}</option>)}
                    </select>
                </div>
                
                <div className="bg-indigo-50/50 p-5 rounded-3xl border border-indigo-100 space-y-4">
                  <div className="space-y-1">
                    <label className="text-[10px] font-bold text-indigo-400 ml-2 uppercase">Pilih Produk</label>
                    <select value={saleProduk} onChange={e => setSaleProduk(e.target.value)} className="w-full p-4 border-0 rounded-2xl bg-white text-sm shadow-sm focus:ring-2 focus:ring-indigo-500">
                        <option value="">-- Pilih Produk --</option>
                        {products.map(p => <option key={p.id} value={p.id}>{p.nama} (Stok: {p.stok})</option>)}
                    </select>
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div className="space-y-1">
                        <label className="text-[10px] font-bold text-indigo-400 ml-2 uppercase">Jumlah Laku</label>
                        <input type="number" placeholder="0" value={saleQty} onChange={e => setSaleQty(e.target.value)} className="w-full p-4 border-0 rounded-2xl text-sm shadow-sm focus:ring-2 focus:ring-indigo-500" />
                    </div>
                    <div className="space-y-1">
                        <label className="text-[10px] font-bold text-indigo-400 ml-2 uppercase">Jumlah Retur</label>
                        <input type="number" placeholder="0" value={saleRetur} onChange={e => setSaleRetur(e.target.value)} className="w-full p-4 border-0 rounded-2xl text-sm shadow-sm focus:ring-2 focus:ring-indigo-500" />
                    </div>
                  </div>
                  <button onClick={saveSale} className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black uppercase text-xs tracking-widest shadow-lg active:scale-95 transition-all">Simpan Laporan Transaksi</button>
                </div>
              </div>
            </div>

            <div className="bg-white rounded-3xl border overflow-hidden shadow-sm">
                <div className="p-4 bg-gray-50 border-b flex justify-between items-center">
                    <span className="text-[10px] font-black text-indigo-600 uppercase">Riwayat Penjualan ({todayStr})</span>
                </div>
                <div className="overflow-x-auto">
                    <table className="w-full text-xs text-left">
                        <thead className="bg-gray-50 text-gray-400 font-black uppercase text-[9px]">
                            <tr><th className="p-4">Toko</th><th className="p-4">Item</th><th className="p-4 text-right">Total Jual</th></tr>
                        </thead>
                        <tbody className="divide-y divide-gray-100">
                            {todaySales.length === 0 ? <tr><td colSpan="3" className="p-10 text-center text-gray-400 italic">Belum ada transaksi hari ini</td></tr> : 
                            todaySales.map(s => s.items.map((it, i) => (
                                <tr key={s.id + i}>
                                    <td className="p-4 font-medium text-gray-600">{s.storeName}</td>
                                    <td className="p-4">
                                        <p className="font-bold">{it.nama}</p>
                                        <p className="text-[9px] text-gray-400">{it.qty} Laku, {it.retur} Retur</p>
                                    </td>
                                    <td className="p-4 text-right font-black text-emerald-600">Rp {it.subtotal.toLocaleString()}</td>
                                </tr>
                            )))}
                        </tbody>
                    </table>
                </div>
            </div>
          </div>
        )}

        {activeTab === 'master' && (
            <div className="space-y-4 animate-in fade-in slide-in-from-bottom-2 duration-500">
                <div className="flex bg-white p-1 rounded-2xl border gap-1">
                    <button onClick={() => setSubTabMaster('produk')} className={`flex-1 py-3 rounded-xl font-black text-[10px] uppercase tracking-widest transition-all ${subTabMaster === 'produk' ? 'bg-indigo-600 text-white shadow-md' : 'text-gray-400'}`}>Katalog Produk</button>
                    <button onClick={() => setSubTabMaster('toko')} className={`flex-1 py-3 rounded-xl font-black text-[10px] uppercase tracking-widest transition-all ${subTabMaster === 'toko' ? 'bg-indigo-600 text-white shadow-md' : 'text-gray-400'}`}>Daftar Toko</button>
                </div>
                
                {subTabMaster === 'produk' ? (
                    <div className="space-y-4">
                        {/* Form Input Produk Updated */}
                        <div className="bg-white p-6 rounded-3xl border-2 border-indigo-100 shadow-sm space-y-4">
                            <h3 className="font-black text-indigo-600 uppercase text-xs tracking-widest">Tambah Produk Baru</h3>
                            <div className="space-y-3">
                                <input type="text" placeholder="Nama Produk (Misal: Sabun Cair)" value={newProdNama} onChange={e => setNewProdNama(e.target.value)} className="w-full p-4 border rounded-2xl text-sm bg-gray-50 focus:ring-2 focus:ring-indigo-500 transition-all" />
                                <div className="grid grid-cols-2 gap-3">
                                    <input type="number" placeholder="Harga Beli (Modal)" value={newProdHargaBeli} onChange={e => setNewProdHargaBeli(e.target.value)} className="p-4 border rounded-2xl text-sm bg-gray-50 focus:ring-2 focus:ring-indigo-500 transition-all" />
                                    <input type="number" placeholder="Harga Jual" value={newProdHargaJual} onChange={e => setNewProdHargaJual(e.target.value)} className="p-4 border rounded-2xl text-sm bg-gray-50 focus:ring-2 focus:ring-indigo-500 transition-all" />
                                </div>
                                <input type="number" placeholder="Jumlah Stok Awal" value={newProdStok} onChange={e => setNewProdStok(e.target.value)} className="w-full p-4 border rounded-2xl text-sm bg-gray-50 focus:ring-2 focus:ring-indigo-500 transition-all" />
                            </div>
                            <button onClick={addProduct} className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-lg active:scale-95 transition-all">Simpan ke Katalog</button>
                        </div>

                        <div className="bg-white p-6 rounded-3xl border shadow-sm">
                            <h3 className="font-black text-gray-400 uppercase text-[10px] mb-4 tracking-widest">Produk Terdaftar</h3>
                            <div className="space-y-3">
                                {products.map(p => (
                                    <div key={p.id} className="flex justify-between items-center p-4 bg-gray-50 rounded-2xl border border-gray-100 hover:border-indigo-200 transition-all group">
                                        <div>
                                            <p className="font-black text-sm text-gray-700">{p.nama}</p>
                                            <div className="flex gap-2 items-center mt-1">
                                                <span className="text-[9px] bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded-full font-bold">Beli: Rp {p.hargaBeli?.toLocaleString()}</span>
                                                <span className="text-[9px] bg-emerald-100 text-emerald-600 px-2 py-0.5 rounded-full font-bold">Jual: Rp {p.hargaJual?.toLocaleString()}</span>
                                            </div>
                                        </div>
                                        <button onClick={async () => { if(confirm("Hapus produk ini?")) await deleteDoc(doc(db,'artifacts',appId,'users',user.uid,'products',p.id)) }} className="text-red-300 hover:text-red-500 font-black p-2 rounded-full transition-colors">Ã—</button>
                                    </div>
                                ))}
                                {products.length === 0 && <p className="text-center text-xs text-gray-400 py-4">Belum ada produk.</p>}
                            </div>
                        </div>
                    </div>
                ) : (
                    <div className="space-y-4">
                        {/* Form Input Toko Updated */}
                        <div className="bg-white p-6 rounded-3xl border-2 border-indigo-100 shadow-sm space-y-4">
                            <h3 className="font-black text-indigo-600 uppercase text-xs tracking-widest">Daftarkan Toko / Cabang</h3>
                            <div className="space-y-3">
                                <input type="text" placeholder="Nama Toko" value={newStoreNama} onChange={e => setNewStoreNama(e.target.value)} className="w-full p-4 border rounded-2xl text-sm bg-gray-50 focus:ring-2 focus:ring-indigo-500" />
                                <textarea placeholder="Alamat Lengkap Toko" value={newStoreAlamat} onChange={e => setNewStoreAlamat(e.target.value)} className="w-full p-4 border rounded-2xl text-sm bg-gray-50 focus:ring-2 focus:ring-indigo-500 h-24 resize-none" />
                            </div>
                            <button onClick={addStore} className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black text-[10px] uppercase tracking-widest shadow-lg">Simpan Lokasi Toko</button>
                        </div>

                        <div className="bg-white p-6 rounded-3xl border shadow-sm">
                            <h3 className="font-black text-gray-400 uppercase text-[10px] mb-4 tracking-widest">List Toko</h3>
                            <div className="space-y-3">
                                {stores.map(s => (
                                    <div key={s.id} className="flex justify-between items-start p-4 bg-gray-50 rounded-2xl border border-gray-100">
                                        <div className="pr-4">
                                            <p className="font-black text-sm text-gray-700">{s.nama}</p>
                                            <p className="text-[10px] text-gray-400 leading-relaxed mt-1">{s.alamat || 'Alamat belum diset'}</p>
                                        </div>
                                        <button onClick={async () => { if(confirm("Hapus toko ini?")) await deleteDoc(doc(db,'artifacts',appId,'users',user.uid,'stores',s.id)) }} className="text-red-300 hover:text-red-500 font-black p-1 transition-colors">Ã—</button>
                                    </div>
                                ))}
                                {stores.length === 0 && <p className="text-center text-xs text-gray-400 py-4">Belum ada toko.</p>}
                            </div>
                        </div>
                    </div>
                )}
            </div>
        )}

        {activeTab === 'ai' && (
            <div className="space-y-4 animate-in zoom-in duration-300">
                <div className="bg-gradient-to-br from-indigo-700 via-indigo-600 to-purple-700 p-8 rounded-[40px] text-white shadow-xl relative overflow-hidden">
                    <div className="absolute top-0 right-0 p-4 opacity-10 text-8xl">âœ¨</div>
                    <h2 className="text-xl font-black mb-2 flex items-center gap-2 relative z-10">Gemini AI Assistant</h2>
                    <p className="text-xs opacity-80 leading-relaxed font-medium relative z-10 uppercase tracking-widest">Business Intelligence Analysis</p>
                </div>
                <div className="bg-white p-8 rounded-[40px] border border-gray-100 shadow-sm min-h-[350px] relative">
                    {isAiLoading ? (
                        <div className="flex flex-col items-center justify-center py-24 gap-6">
                            <div className="relative">
                                <div className="animate-ping absolute inset-0 h-full w-full rounded-full bg-indigo-400 opacity-20"></div>
                                <div className="animate-spin h-10 w-10 border-4 border-indigo-600 border-t-transparent rounded-full relative"></div>
                            </div>
                            <p className="text-[10px] font-black text-indigo-400 uppercase tracking-[0.2em] animate-pulse">Menghitung Strategi Bisnis...</p>
                        </div>
                    ) : aiAnalysis ? (
                        <div className="space-y-6">
                            <div className="flex items-center gap-2 border-b pb-4">
                                <span className="bg-indigo-100 text-indigo-600 p-2 rounded-lg text-xs">âœ¨</span>
                                <h4 className="text-[10px] font-black uppercase text-gray-400 tracking-widest">Hasil Analisis Strategis</h4>
                            </div>
                            <p className="text-sm leading-relaxed text-gray-600 font-medium whitespace-pre-wrap">{aiAnalysis}</p>
                            <div className="pt-6 flex justify-center">
                                <button onClick={() => setAiAnalysis('')} className="bg-gray-100 text-gray-500 px-6 py-2 rounded-full text-[10px] font-black uppercase tracking-widest hover:bg-red-50 hover:text-red-500 transition-all">Reset Analisis</button>
                            </div>
                        </div>
                    ) : (
                        <div className="flex flex-col items-center justify-center py-20 text-center gap-6">
                            <div className="bg-indigo-50 p-6 rounded-full text-3xl">ðŸ¤–</div>
                            <div className="space-y-2 px-6">
                                <h4 className="font-black text-gray-700">Belum Ada Analisis</h4>
                                <p className="text-xs text-gray-400 font-medium">Buka menu Dashboard dan klik "Analisis Pintar" untuk melihat performa tokomu.</p>
                            </div>
                        </div>
                    )}
                </div>
            </div>
        )}
      </main>

      <nav className="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-xl border-t border-gray-100 flex h-24 shadow-[0_-10px_40px_rgba(0,0,0,0.05)] z-50 px-6 items-center">
        {[
          { id: 'dashboard', label: 'Beranda', icon: 'ðŸ ' },
          { id: 'penjualan', label: 'Kasir', icon: 'ðŸ’°' },
          { id: 'master', label: 'Data', icon: 'ðŸ“¦' },
          { id: 'ai', label: 'Gemini', icon: 'âœ¨' }
        ].map(btn => (
          <button 
            key={btn.id}
            onClick={() => setActiveTab(btn.id)}
            className={`flex-1 flex flex-col items-center gap-1.5 transition-all duration-300 ${activeTab === btn.id ? 'text-indigo-600 scale-110' : 'text-gray-300 hover:text-gray-400'}`}
          >
            <span className="text-xl">{btn.icon}</span>
            <span className={`text-[8px] font-black uppercase tracking-widest transition-opacity ${activeTab === btn.id ? 'opacity-100' : 'opacity-60'}`}>{btn.label}</span>
            {activeTab === btn.id && <div className="w-1 h-1 bg-indigo-600 rounded-full"></div>}
          </button>
        ))}
      </nav>
    </div>
  );
}
