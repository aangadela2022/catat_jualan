<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistem Penjualan Lokal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.0/lucide.min.js"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .nav-active { color: #4f46e5; border-top: 3px solid #4f46e5; background: #f8fafc; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        th { font-size: 10px; text-transform: uppercase; color: #64748b; padding: 12px; background: #f8fafc; font-weight: 800; border-bottom: 1px solid #e2e8f0; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }
    </style>
</head>
<body class="bg-gray-50 pb-28">

    <header class="bg-indigo-600 text-white p-4 sticky top-0 z-50 shadow-md flex justify-between items-center">
        <div class="flex items-center gap-2">
            <i data-lucide="zap" class="fill-yellow-300 text-yellow-300"></i>
            <h1 class="text-lg font-bold tracking-tight">SalesPro <span class="text-[10px] bg-indigo-500 px-2 py-0.5 rounded ml-1">OFFLINE</span></h1>
        </div>
        <div id="db-status" class="text-[10px] bg-indigo-700 px-3 py-1 rounded-full font-bold uppercase">Mode Lokal</div>
    </header>

    <div class="max-w-4xl mx-auto p-4">
        
        <!-- DASHBOARD TAB -->
        <section id="tab-dashboard" class="tab-content active space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-indigo-500">
                    <p class="text-[10px] text-gray-400 uppercase font-black">Omzet Hari Ini</p>
                    <p id="dash-omzet" class="text-xl font-black text-gray-800">Rp 0</p>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border-l-4 border-emerald-500">
                    <p class="text-[10px] text-gray-400 uppercase font-black">Profit Hari Ini</p>
                    <p id="dash-profit" class="text-xl font-black text-emerald-600">Rp 0</p>
                </div>
            </div>

            <div class="bg-white p-5 rounded-2xl border shadow-sm">
                <h3 class="text-xs font-black text-gray-500 uppercase tracking-widest mb-4">Ringkasan Mingguan</h3>
                <div class="relative h-48">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>
        </section>

        <!-- STOK TAB -->
        <section id="tab-pembelian" class="tab-content space-y-4">
            <div class="bg-white p-5 rounded-2xl shadow-sm border">
                <h2 class="text-md font-bold mb-4 flex items-center gap-2 text-indigo-600">Tambah Stok Produk</h2>
                <form id="form-update-stok" class="space-y-3">
                    <select id="update-stok-produk" class="w-full p-3 border rounded-xl bg-gray-50" required></select>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" id="update-stok-qty" placeholder="Jumlah Tambah" class="w-full p-3 border rounded-xl" required>
                        <button type="submit" class="bg-indigo-600 text-white rounded-xl font-bold">Update</button>
                    </div>
                </form>
            </div>

            <div class="bg-white rounded-2xl border shadow-sm overflow-hidden">
                <div class="p-4 border-b bg-gray-50">
                    <span class="text-xs font-black text-indigo-600 uppercase tracking-widest">Ketersediaan Stok</span>
                </div>
                <div class="table-container">
                    <table class="w-full text-left text-xs">
                        <thead>
                            <tr><th>Produk</th><th class="text-center">Stok</th><th class="text-right">Harga Jual</th></tr>
                        </thead>
                        <tbody id="table-stok-body" class="divide-y"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- KASIR TAB -->
        <section id="tab-penjualan" class="tab-content space-y-6">
            <div class="bg-white p-5 rounded-2xl shadow-sm border">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-md font-bold flex items-center gap-2 text-indigo-600">Input Penjualan</h2>
                    <div class="text-right">
                        <p id="sale-current-day" class="text-[10px] font-black text-gray-400 uppercase"></p>
                        <p id="sale-current-date" class="text-xs font-bold text-gray-600"></p>
                    </div>
                </div>
                
                <form id="form-sale" class="space-y-4">
                    <select id="sale-toko" class="w-full p-3 border rounded-xl bg-gray-50" required></select>
                    <div class="p-4 rounded-xl bg-indigo-50 border border-indigo-100 space-y-3">
                        <select id="sale-produk" class="w-full p-3 border rounded-xl bg-white"></select>
                        <div class="grid grid-cols-2 gap-3">
                            <input type="number" id="sale-qty" placeholder="Jumlah Laku" class="w-full p-3 border rounded-xl">
                            <input type="number" id="sale-retur" placeholder="Retur (Jika ada)" class="w-full p-3 border rounded-xl">
                        </div>
                        <button type="button" id="btn-save-sale" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-black uppercase shadow-lg active:scale-95 transition-transform">SIMPAN TRANSAKSI</button>
                    </div>
                </form>
            </div>

            <div class="bg-white rounded-2xl border shadow-sm overflow-hidden">
                <div class="p-4 border-b bg-gray-50">
                    <span class="text-xs font-black text-indigo-600 uppercase tracking-widest">Penjualan Hari Ini</span>
                </div>
                <div class="table-container">
                    <table class="w-full text-left text-xs">
                        <thead>
                            <tr>
                                <th>Toko</th>
                                <th>Produk</th>
                                <th class="text-center">Qty</th>
                                <th class="text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody id="table-penjualan-hari-ini" class="divide-y"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- LABA RUGI TAB -->
        <section id="tab-labarugi" class="tab-content space-y-4">
            <div class="bg-white p-5 rounded-2xl border shadow-sm">
                <h3 class="text-xs font-black text-gray-500 uppercase tracking-widest mb-4">Laporan Keuangan</h3>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Dari</label>
                        <input type="date" id="lr-start" class="w-full p-2 border rounded-lg text-xs">
                    </div>
                    <div class="space-y-1">
                        <label class="text-[10px] font-bold text-gray-400 uppercase">Hingga</label>
                        <input type="date" id="lr-end" class="w-full p-2 border rounded-lg text-xs">
                    </div>
                </div>
                <button id="btn-calc-lr" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold text-sm mb-6 shadow-md">HITUNG LABA RUGI</button>
                
                <div class="space-y-4">
                    <div class="flex justify-between items-center border-b pb-2">
                        <span class="text-sm text-gray-600">Total Penjualan</span>
                        <span id="lr-omzet" class="text-sm font-bold text-gray-800">Rp 0</span>
                    </div>
                    <div class="flex justify-between items-center border-b pb-2">
                        <span class="text-sm text-gray-600">HPP (Modal)</span>
                        <span id="lr-modal" class="text-sm font-bold text-red-500">Rp 0</span>
                    </div>
                    <div class="flex justify-between items-center bg-emerald-50 p-4 rounded-xl">
                        <span class="text-sm font-bold text-emerald-800 uppercase">Laba Bersih</span>
                        <span id="lr-bersih" class="text-xl font-black text-emerald-600">Rp 0</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- MASTER DATA TAB -->
        <section id="tab-master" class="tab-content space-y-4">
            <div class="flex gap-2">
                <button onclick="subMaster('produk')" id="sub-p" class="flex-1 py-2 rounded-lg font-bold text-xs bg-indigo-600 text-white shadow">Produk</button>
                <button onclick="subMaster('toko')" id="sub-t" class="flex-1 py-2 rounded-lg font-bold text-xs bg-gray-200 text-gray-600">Toko</button>
            </div>
            
            <div id="pane-produk" class="space-y-4">
                <form id="form-master-produk" class="bg-white p-4 rounded-2xl border shadow-sm space-y-3">
                    <input id="m-p-nama" placeholder="Nama Produk" class="w-full p-3 border rounded-xl" required>
                    <div class="grid grid-cols-2 gap-2">
                        <input id="m-p-beli" type="number" placeholder="Harga Modal" class="p-3 border rounded-xl" required>
                        <input id="m-p-jual" type="number" placeholder="Harga Jual" class="p-3 border rounded-xl" required>
                    </div>
                    <input id="m-p-stok" type="number" placeholder="Stok Awal" class="w-full p-3 border rounded-xl" required>
                    <button class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow">SIMPAN PRODUK</button>
                </form>
                <div class="bg-white rounded-2xl border overflow-hidden shadow-sm">
                    <div class="p-3 bg-gray-50 border-b flex justify-between">
                        <span class="text-[10px] font-black text-gray-500 uppercase">Master Produk</span>
                        <span id="count-produk" class="text-[10px] font-bold text-indigo-600">0 Item</span>
                    </div>
                    <div class="table-container">
                        <table class="w-full text-left text-xs">
                            <thead>
                                <tr><th>Nama</th><th class="text-right">Modal</th><th class="text-right">Jual</th><th class="text-center">Aksi</th></tr>
                            </thead>
                            <tbody id="list-produk" class="divide-y"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="pane-toko" class="hidden space-y-4">
                <form id="form-master-toko" class="bg-white p-4 rounded-2xl border shadow-sm space-y-3">
                    <input id="m-t-nama" placeholder="Nama Toko" class="w-full p-3 border rounded-xl" required>
                    <input id="m-t-alamat" placeholder="Lokasi/Alamat" class="w-full p-3 border rounded-xl">
                    <button class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow">SIMPAN TOKO</button>
                </form>
                <div class="bg-white rounded-2xl border overflow-hidden shadow-sm">
                    <div class="p-3 bg-gray-50 border-b"><span class="text-[10px] font-black text-gray-500 uppercase">Master Toko</span></div>
                    <div class="table-container">
                        <table class="w-full text-left text-xs">
                            <thead>
                                <tr><th>Toko</th><th>Alamat</th><th class="text-center">Aksi</th></tr>
                            </thead>
                            <tbody id="list-toko" class="divide-y"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- NAVBAR BOTTOM -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex h-20 shadow-[0_-10px_20px_rgba(0,0,0,0.05)] z-50 px-2">
        <button onclick="navTo('dashboard')" class="nav-btn flex-1 flex flex-col items-center justify-center gap-1 nav-active" data-id="dashboard"><i data-lucide="home" size="18"></i><span class="text-[8px] font-bold uppercase">Home</span></button>
        <button onclick="navTo('pembelian')" class="nav-btn flex-1 flex flex-col items-center justify-center gap-1 text-gray-400" data-id="pembelian"><i data-lucide="package" size="18"></i><span class="text-[8px] font-bold uppercase">Stok</span></button>
        <button onclick="navTo('penjualan')" class="nav-btn flex-1 flex flex-col items-center justify-center gap-1 text-gray-400" data-id="penjualan"><i data-lucide="shopping-cart" size="18"></i><span class="text-[8px] font-bold uppercase">Kasir</span></button>
        <button onclick="navTo('labarugi')" class="nav-btn flex-1 flex flex-col items-center justify-center gap-1 text-gray-400" data-id="labarugi"><i data-lucide="trending-up" size="18"></i><span class="text-[8px] font-bold uppercase">Laba Rugi</span></button>
        <button onclick="navTo('master')" class="nav-btn flex-1 flex flex-col items-center justify-center gap-1 text-gray-400" data-id="master"><i data-lucide="database" size="18"></i><span class="text-[8px] font-bold uppercase">Data</span></button>
    </nav>

    <div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-2xl text-xs font-bold hidden z-[100] shadow-2xl animate-bounce"></div>

    <script>
        // INISIALISASI DATABASE LOKAL (DEXIE JS)
        const db = new Dexie("CashierLocalDB");
        db.version(1).stores({
            products: "++id, nama, hargaBeli, harga, stok",
            stores: "++id, nama, alamat",
            sales: "++id, storeId, timestamp, totalOmzet"
        });

        let salesChart;

        // UI HELPERS
        const showToast = (m) => { 
            const t = document.getElementById('toast'); 
            t.innerText = m; 
            t.classList.remove('hidden'); 
            setTimeout(() => t.classList.add('hidden'), 2000); 
        };

        const formatIDR = (num) => "Rp " + (num || 0).toLocaleString('id-ID');

        // NAVIGATION
        window.navTo = (id) => {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-'+id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => {
                const isActive = b.dataset.id === id;
                b.classList.toggle('nav-active', isActive);
                b.classList.toggle('text-gray-400', !isActive);
            });
            refreshAllData();
            if(id === 'dashboard') initChart();
        };

        window.subMaster = (t) => {
            document.getElementById('pane-produk').classList.toggle('hidden', t !== 'produk');
            document.getElementById('pane-toko').classList.toggle('hidden', t !== 'toko');
            document.getElementById('sub-p').className = t === 'produk' ? 'flex-1 py-2 rounded-lg font-bold text-xs bg-indigo-600 text-white shadow' : 'flex-1 py-2 rounded-lg font-bold text-xs bg-gray-200 text-gray-600';
            document.getElementById('sub-t').className = t === 'toko' ? 'flex-1 py-2 rounded-lg font-bold text-xs bg-indigo-600 text-white shadow' : 'flex-1 py-2 rounded-lg font-bold text-xs bg-gray-200 text-gray-600';
        };

        // CORE DATA FUNCTIONS
        const refreshAllData = async () => {
            const products = await db.products.toArray();
            const stores = await db.stores.toArray();
            const sales = await db.sales.toArray();
            const now = new Date();
            const todayStr = now.toLocaleDateString();

            // 1. Refresh Dropdowns
            const optProduk = `<option value="">-- Pilih Produk --</option>` + products.map(p => `<option value="${p.id}">${p.nama} (Sisa: ${p.stok})</option>`).join('');
            const optToko = `<option value="">-- Pilih Toko --</option>` + stores.map(s => `<option value="${s.id}">${s.nama}</option>`).join('');
            
            ['update-stok-produk', 'sale-produk'].forEach(id => { if(document.getElementById(id)) document.getElementById(id).innerHTML = optProduk; });
            if(document.getElementById('sale-toko')) document.getElementById('sale-toko').innerHTML = optToko;

            // 2. Refresh Stok Table
            document.getElementById('table-stok-body').innerHTML = products.map(p => `
                <tr>
                    <td><b>${p.nama}</b></td>
                    <td class="text-center font-bold ${p.stok < 5 ? 'text-red-500' : 'text-indigo-600'}">${p.stok}</td>
                    <td class="text-right">${formatIDR(p.harga)}</td>
                </tr>`).join('');

            // 3. Refresh Master Lists
            document.getElementById('list-produk').innerHTML = products.map(p => `
                <tr>
                    <td><b>${p.nama}</b></td>
                    <td class="text-right">${formatIDR(p.hargaBeli)}</td>
                    <td class="text-right font-bold text-indigo-600">${formatIDR(p.harga)}</td>
                    <td class="text-center"><button onclick="delItem('products', ${p.id})" class="text-red-400 text-lg font-bold px-2">×</button></td>
                </tr>`).join('');
            
            document.getElementById('list-toko').innerHTML = stores.map(s => `
                <tr>
                    <td><b>${s.nama}</b></td>
                    <td><small class="text-gray-500">${s.alamat || '-'}</small></td>
                    <td class="text-center"><button onclick="delItem('stores', ${s.id})" class="text-red-400 text-lg font-bold px-2">×</button></td>
                </tr>`).join('');
            
            document.getElementById('count-produk').innerText = products.length + " Item";

            // 4. Dashboard Stats
            const todaySales = sales.filter(s => new Date(s.timestamp).toLocaleDateString() === todayStr);
            const omzet = todaySales.reduce((a,c) => a + c.totalOmzet, 0);
            const profit = todaySales.reduce((a,c) => a + c.totalProfit, 0);
            document.getElementById('dash-omzet').innerText = formatIDR(omzet);
            document.getElementById('dash-profit').innerText = formatIDR(profit);

            // 5. Penjualan Hari Ini
            document.getElementById('table-penjualan-hari-ini').innerHTML = todaySales.map(s => `
                <tr>
                    <td>${s.storeName}</td>
                    <td><b>${s.items[0].nama}</b></td>
                    <td class="text-center">${s.items[0].qty}</td>
                    <td class="text-right font-bold text-indigo-600">${formatIDR(s.totalOmzet)}</td>
                </tr>`).join('');
            
            // Re-render icons after dynamic content update
            if (window.lucide) {
                window.lucide.createIcons();
            }
        };

        // EVENT HANDLERS
        document.getElementById('form-master-produk').onsubmit = async (e) => {
            e.preventDefault();
            await db.products.add({
                nama: document.getElementById('m-p-nama').value,
                hargaBeli: parseInt(document.getElementById('m-p-beli').value),
                harga: parseInt(document.getElementById('m-p-jual').value),
                stok: parseInt(document.getElementById('m-p-stok').value)
            });
            e.target.reset(); showToast("Produk Disimpan!"); refreshAllData();
        };

        document.getElementById('form-master-toko').onsubmit = async (e) => {
            e.preventDefault();
            await db.stores.add({
                nama: document.getElementById('m-t-nama').value,
                alamat: document.getElementById('m-t-alamat').value
            });
            e.target.reset(); showToast("Toko Disimpan!"); refreshAllData();
        };

        document.getElementById('form-update-stok').onsubmit = async (e) => {
            e.preventDefault();
            const id = parseInt(document.getElementById('update-stok-produk').value);
            const qty = parseInt(document.getElementById('update-stok-qty').value);
            const p = await db.products.get(id);
            await db.products.update(id, { stok: p.stok + qty });
            e.target.reset(); showToast("Stok Ditambah!"); refreshAllData();
        };

        document.getElementById('btn-save-sale').onclick = async () => {
            const sid = parseInt(document.getElementById('sale-toko').value);
            const pid = parseInt(document.getElementById('sale-produk').value);
            const qty = parseInt(document.getElementById('sale-qty').value) || 0;
            const ret = parseInt(document.getElementById('sale-retur').value) || 0;

            if(!sid || !pid || qty <= 0) return showToast("Lengkapi input!");

            const p = await db.products.get(pid);
            const s = await db.stores.get(sid);
            
            const totalQty = qty - ret;
            const totalOmzet = totalQty * p.harga;
            const totalProfit = totalQty * (p.harga - p.hargaBeli);

            await db.sales.add({
                storeId: sid,
                storeName: s.nama,
                timestamp: new Date().getTime(),
                totalOmzet,
                totalProfit,
                items: [{ nama: p.nama, qty: totalQty, harga: p.harga, hargaBeli: p.hargaBeli }]
            });

            await db.products.update(pid, { stok: p.stok - totalQty });
            
            document.getElementById('sale-qty').value = '';
            document.getElementById('sale-retur').value = '';
            showToast("Transaksi Berhasil!");
            refreshAllData();
            initChart();
        };

        window.delItem = async (tbl, id) => {
            if(confirm("Hapus data ini?")) {
                await db[tbl].delete(id);
                refreshAllData();
            }
        };

        document.getElementById('btn-calc-lr').onclick = async () => {
            const startStr = document.getElementById('lr-start').value;
            const endStr = document.getElementById('lr-end').value;
            if(!startStr || !endStr) return showToast("Pilih rentang tanggal!");

            const start = new Date(startStr).setHours(0,0,0,0);
            const end = new Date(endStr).setHours(23,59,59,999);
            const allSales = await db.sales.toArray();
            const filtered = allSales.filter(s => s.timestamp >= start && s.timestamp <= end);
            
            const omzet = filtered.reduce((a,c) => a + c.totalOmzet, 0);
            const profit = filtered.reduce((a,c) => a + c.totalProfit, 0);
            const modal = omzet - profit;

            document.getElementById('lr-omzet').innerText = formatIDR(omzet);
            document.getElementById('lr-modal').innerText = formatIDR(modal);
            document.getElementById('lr-bersih').innerText = formatIDR(profit);
        };

        // CHART LOGIC
        const initChart = async () => {
            const canvas = document.getElementById('salesChart');
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            const allSales = await db.sales.toArray();
            const labels = [], data = [];
            
            for(let i=6; i>=0; i--) {
                const d = new Date(); d.setDate(d.getDate()-i);
                const dStr = d.toLocaleDateString();
                labels.push(d.toLocaleDateString('id-ID', {day:'numeric', month:'short'}));
                const val = allSales.filter(s => new Date(s.timestamp).toLocaleDateString() === dStr).reduce((a,c)=>a+c.totalOmzet, 0);
                data.push(val);
            }

            if(salesChart) salesChart.destroy();
            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Omzet',
                        data,
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79,70,229,0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, display: false } }
                }
            });
        };

        // SAFE ICON INITIALIZER
        const initIcons = () => {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            } else {
                setTimeout(initIcons, 100);
            }
        };

        // INIT ON LOAD
        window.addEventListener('load', () => {
            initIcons();
            const today = new Date().toISOString().split('T')[0];
            ['lr-start', 'lr-end'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = today;
            });
            
            const days = ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];
            const months = ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agu','Sep','Okt','Nov','Des'];
            const now = new Date();
            
            const dayEl = document.getElementById('sale-current-day');
            const dateEl = document.getElementById('sale-current-date');
            if(dayEl) dayEl.innerText = days[now.getDay()];
            if(dateEl) dateEl.innerText = `${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
            
            refreshAllData();
            initChart();
        });
    </script>
</body>
</html>
