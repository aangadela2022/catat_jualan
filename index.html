<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Pro V8 - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        .active-tab { color: #4f46e5; transform: scale(1.1); }
        .tab-indicator { height: 4px; width: 4px; background: #4f46e5; border-radius: 50%; margin-top: 4px; }
    </style>
</head>
<body class="bg-gray-50 pb-28">

    <!-- Header -->
    <header class="bg-indigo-700 text-white p-5 sticky top-0 z-50 shadow-md flex justify-between items-center">
        <div class="flex items-center gap-2">
            <span class="font-black italic text-xl tracking-tighter uppercase">Sales Pro V8</span>
        </div>
        <div id="user-id" class="text-[9px] bg-white/20 px-3 py-1 rounded-full font-mono font-bold backdrop-blur-sm">
            Memuat...
        </div>
    </header>

    <!-- Main Content Containers -->
    <main id="app-content" class="max-w-4xl mx-auto p-4 space-y-4">
        <!-- Konten akan diisi oleh JavaScript -->
    </main>

    <!-- Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-xl border-t border-gray-100 flex h-20 shadow-[0_-10px_40px_rgba(0,0,0,0.05)] z-50 px-6 items-center">
        <button onclick="switchTab('dashboard')" class="flex-1 flex flex-col items-center gap-1 text-gray-400 nav-btn" id="nav-dashboard">
            <span class="text-xl">üè†</span>
            <span class="text-[8px] font-black uppercase tracking-widest">Beranda</span>
            <div class="indicator hidden"></div>
        </button>
        <button onclick="switchTab('kasir')" class="flex-1 flex flex-col items-center gap-1 text-gray-400 nav-btn" id="nav-kasir">
            <span class="text-xl">üí∞</span>
            <span class="text-[8px] font-black uppercase tracking-widest">Kasir</span>
            <div class="indicator hidden"></div>
        </button>
        <button onclick="switchTab('data')" class="flex-1 flex flex-col items-center gap-1 text-gray-400 nav-btn" id="nav-data">
            <span class="text-xl">üì¶</span>
            <span class="text-[8px] font-black uppercase tracking-widest">Data</span>
            <div class="indicator hidden"></div>
        </button>
    </nav>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // Global State
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'v8-sales-app';
        
        let currentUser = null;
        let products = [];
        let stores = [];
        let sales = [];
        let currentTab = 'dashboard';

        // Initialize Auth
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-id').innerText = `ID: ${user.uid.slice(0,8)}`;
                initDataListeners();
            } else {
                signInAnonymously(auth);
            }
        });

        function initDataListeners() {
            const userPath = (col) => collection(db, 'artifacts', appId, 'users', currentUser.uid, col);
            
            onSnapshot(userPath('products'), (s) => {
                products = s.docs.map(d => ({id: d.id, ...d.data()}));
                render();
            });
            onSnapshot(userPath('stores'), (s) => {
                stores = s.docs.map(d => ({id: d.id, ...d.data()}));
                render();
            });
            onSnapshot(userPath('sales'), (s) => {
                sales = s.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => b.timestamp - a.timestamp);
                render();
            });
        }

        // Global functions for buttons
        window.switchTab = (tab) => {
            currentTab = tab;
            render();
        };

        window.addProduct = async () => {
            const nama = document.getElementById('prod-nama').value;
            const beli = document.getElementById('prod-beli').value;
            const jual = document.getElementById('prod-jual').value;
            const stok = document.getElementById('prod-stok').value;
            if(!nama || !beli || !jual || !stok) return alert("Isi semua data!");
            
            await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'products'), {
                nama, hargaBeli: Number(beli), hargaJual: Number(jual), stok: Number(stok), timestamp: Timestamp.now()
            });
            alert("Produk disimpan");
        };

        window.addStore = async () => {
            const nama = document.getElementById('store-nama').value;
            const alamat = document.getElementById('store-alamat').value;
            if(!nama || !alamat) return alert("Isi nama dan alamat!");

            await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'stores'), {
                nama, alamat, timestamp: Timestamp.now()
            });
            alert("Toko disimpan");
        };

        window.saveSale = async () => {
            const storeId = document.getElementById('sale-toko').value;
            const prodId = document.getElementById('sale-prod').value;
            const qty = Number(document.getElementById('sale-qty').value);
            
            if(!storeId || !prodId || !qty) return alert("Lengkapi data transaksi!");
            
            const prod = products.find(p => p.id === prodId);
            const store = stores.find(s => s.id === storeId);
            const total = qty * prod.hargaJual;

            await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'sales'), {
                storeName: store.nama,
                prodNama: prod.nama,
                qty,
                total,
                timestamp: Timestamp.now()
            });
            alert("Transaksi Berhasil!");
        };

        window.deleteItem = async (col, id) => {
            if(confirm("Hapus data ini?")) {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, col, id));
            }
        };

        function render() {
            const main = document.getElementById('app-content');
            
            // Update UI Nav
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active-tab'));
            document.querySelectorAll('.indicator').forEach(ind => ind.classList.add('hidden'));
            document.getElementById(`nav-${currentTab}`).classList.add('active-tab');
            document.getElementById(`nav-${currentTab}`).querySelector('.indicator').classList.remove('hidden');

            if (currentTab === 'dashboard') {
                const totalOmzet = sales.reduce((a,b) => a + b.total, 0);
                main.innerHTML = `
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-white p-5 rounded-3xl shadow-sm border-l-4 border-emerald-500">
                            <p class="text-[10px] text-gray-400 uppercase font-black">Total Omzet</p>
                            <p class="text-xl font-black">Rp ${totalOmzet.toLocaleString()}</p>
                        </div>
                        <div class="bg-indigo-600 p-5 rounded-3xl shadow-sm text-white">
                            <p class="text-[10px] opacity-70 uppercase font-black">Total Produk</p>
                            <p class="text-xl font-black">${products.length}</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
                        <h3 class="text-[10px] font-black text-indigo-600 uppercase mb-4 tracking-widest">Stok Menipis</h3>
                        <div class="space-y-3">
                            ${products.filter(p => p.stok < 10).map(p => `
                                <div class="flex justify-between items-center text-sm">
                                    <span class="font-bold text-gray-600">${p.nama}</span>
                                    <span class="text-red-500 font-black">${p.stok} unit</span>
                                </div>
                            `).join('') || '<p class="text-xs text-gray-400 italic text-center">Stok aman semua.</p>'}
                        </div>
                    </div>
                `;
            }

            if (currentTab === 'kasir') {
                main.innerHTML = `
                    <div class="bg-white p-6 rounded-3xl shadow-sm space-y-4 border border-indigo-50">
                        <h2 class="text-xs font-black text-indigo-600 uppercase tracking-widest">Input Penjualan</h2>
                        <select id="sale-toko" class="w-full p-4 bg-gray-50 rounded-2xl text-sm border-0 focus:ring-2 focus:ring-indigo-500">
                            <option value="">-- Pilih Toko --</option>
                            ${stores.map(s => `<option value="${s.id}">${s.nama}</option>`).join('')}
                        </select>
                        <select id="sale-prod" class="w-full p-4 bg-gray-50 rounded-2xl text-sm border-0 focus:ring-2 focus:ring-indigo-500">
                            <option value="">-- Pilih Produk --</option>
                            ${products.map(p => `<option value="${p.id}">${p.nama} (Rp ${p.hargaJual.toLocaleString()})</option>`).join('')}
                        </select>
                        <input type="number" id="sale-qty" placeholder="Jumlah Laku" class="w-full p-4 bg-gray-50 rounded-2xl text-sm border-0 focus:ring-2 focus:ring-indigo-500">
                        <button onclick="saveSale()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black uppercase text-xs tracking-widest shadow-lg active:scale-95 transition-all">Selesaikan Transaksi</button>
                    </div>
                `;
            }

            if (currentTab === 'data') {
                main.innerHTML = `
                    <div class="space-y-6">
                        <!-- Form Produk -->
                        <div class="bg-white p-6 rounded-3xl shadow-sm space-y-4 border border-gray-100">
                            <h3 class="text-xs font-black text-indigo-600 uppercase tracking-widest">Tambah Produk Baru</h3>
                            <input type="text" id="prod-nama" placeholder="Nama Produk" class="w-full p-4 bg-gray-50 rounded-2xl text-sm border-0">
                            <div class="grid grid-cols-2 gap-2">
                                <input type="number" id="prod-beli" placeholder="Harga Beli" class="w-full p-4 bg-gray-50 rounded-2xl text-sm border-0">
                                <input type="number" id="prod-jual" placeholder="Harga Jual" class="w-full p-4 bg-gray-50 rounded-2xl text-sm border-0">
                            </div>
                            <input type="number" id="prod-stok" placeholder="Stok" class="w-full p-4 bg-gray-50 rounded-2xl text-sm border-0">
                            <button onclick="addProduct()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black uppercase text-[10px] tracking-widest shadow-md">Simpan Produk</button>
                        </div>

                        <!-- Form Toko -->
                        <div class="bg-white p-6 rounded-3xl shadow-sm space-y-4 border border-gray-100">
                            <h3 class="text-xs font-black text-indigo-600 uppercase tracking-widest">Tambah Toko / Cabang</h3>
                            <input type="text" id="store-nama" placeholder="Nama Toko" class="w-full p-4 bg-gray-50 rounded-2xl text-sm border-0">
                            <textarea id="store-alamat" placeholder="Alamat Lengkap Toko" class="w-full p-4 bg-gray-50 rounded-2xl text-sm border-0 h-20"></textarea>
                            <button onclick="addStore()" class="w-full bg-gray-800 text-white py-4 rounded-2xl font-black uppercase text-[10px] tracking-widest shadow-md">Simpan Toko</button>
                        </div>

                        <!-- List Toko -->
                        <div class="space-y-2">
                            <h3 class="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-2">Daftar Toko Terdaftar</h3>
                            ${stores.map(s => `
                                <div class="bg-white p-4 rounded-2xl shadow-sm flex justify-between items-center border border-gray-50">
                                    <div>
                                        <p class="font-bold text-sm text-gray-700">${s.nama}</p>
                                        <p class="text-[10px] text-gray-400">${s.alamat}</p>
                                    </div>
                                    <button onclick="deleteItem('stores', '${s.id}')" class="text-red-300 text-xl font-bold p-2">√ó</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        }

        render();
    </script>
</body>
</html>
